{% load humanize %}
{% load tracker_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Life Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 3rem;
        }
        h1 {
            font-weight: 700;
            color: #212529;
            margin-bottom: 2rem;
        }
        h1 i {
            color: #0d6efd;
            margin-right: 0.5rem;
        }
        .date-selector {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .tracker-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .tracker-table table {
            margin-bottom: 0;
        }
        .tracker-table th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            padding: 1rem;
            border: none;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        .tracker-table th:last-child {
            border-right: none;
        }
        .tracker-table td {
            padding: 1rem;
            vertical-align: middle;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }
        .tracker-table td:last-child {
            border-right: none;
        }
        .tracker-table tbody tr:last-child td {
            border-bottom: none;
        }
        .tracker-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .tracker-table td.day-cell {
            font-weight: 600;
            color: #495057;
            text-align: left !important;
        }
        .date-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
        .checkbox-cell i {
            font-size: 1.5rem;
            color: #0d6efd;
        }
        .week-label {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        /* Tooltip styling for column headers */
        .tracker-table th {
            position: relative;
            cursor: help;
        }
        .tracker-table th[data-bs-toggle="tooltip"] {
            cursor: help;
        }
    </style>
</head>
<body>
    <!-- Top Right Controls - Fixed Position -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; gap: 8px; align-items: center;">
        <button class="btn btn-warning btn-sm" onclick="runMasterSync()">
            <i class="bi bi-arrow-repeat"></i> Run Master Sync
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="navMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-list" style="font-size: 1.2rem;"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navMenuButton">
                <li><a class="dropdown-item" href="/activity-logger/">Activity Logger</a></li>
                <li><a class="dropdown-item" href="/activity-report/">Activity Report</a></li>
                <li><a class="dropdown-item active" href="/life-tracker/">Life Tracker</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/settings/">Settings</a></li>
                <li><a class="dropdown-item" href="/admin/">Admin</a></li>
            </ul>
        </div>
    </div>

    <div class="container mt-5">
        <h1 class="mb-4"><i class="bi bi-clipboard-check"></i>Life Tracker</h1>

        <!-- Date Selector (Week Picker) -->
        <div class="date-selector">
            <form method="GET" action="{% url 'life_tracker' %}" id="dateForm">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-6 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-calendar-week"></i> Load Week
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="currentWeekBtn">
                            <i class="bi bi-calendar-check"></i> Current Week
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Life Tracker Table -->
        <div class="tracker-table">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="text-align: left; width: 20%;">Day</th>
                        {% for column in columns %}
                        <th style="width: {% widthratio 80 columns.count 1 %}%;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ column.tooltip_text }}">{{ column.display_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in days %}
                    <tr>
                        <td class="day-cell">
                            {{ day.name }}
                            <span class="date-label">({{ day.date_str }})</span>
                        </td>
                        {% for column in columns %}
                        <td class="checkbox-cell {% if column.column_name == 'write' %}write-cell{% endif %}" data-date="{{ day.date_iso }}" data-column="{{ column.column_name }}">
                            {% if column.column_name == 'write' %}
                                {% if day.has_writing %}
                                    <i class="bi bi-check-square-fill"></i>
                                {% else %}
                                    <i class="bi bi-plus-circle add-writing-icon" style="cursor: pointer; color: #6c757d; display: none;"></i>
                                {% endif %}
                            {% else %}
                                {% with key="has_"|add:column.column_name %}
                                    {% if day|get_item:key %}<i class="bi bi-check-square-fill"></i>{% endif %}
                                {% endwith %}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Writing Log Modal -->
    <div class="modal fade" id="writingModal" tabindex="-1" aria-labelledby="writingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="writingModalLabel">Writing Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="fs-5">Did you write for 1.5+ hours on this day?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" id="confirmWritingBtn">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // Current week button
        document.getElementById('currentWeekBtn').addEventListener('click', function() {
            window.location.href = '{% url "life_tracker" %}';
        });

        // Helper functions
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        function showFlashMessage(message, isSuccess = true) {
            // Determine alert type based on message prefix or isSuccess
            let alertType = 'success';
            if (!isSuccess) {
                alertType = 'danger';
            } else if (message.startsWith('‚ö†Ô∏è')) {
                alertType = 'warning';
            }

            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${alertType} alert-dismissible fade show`;
            alertDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10001; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Add to page
            document.body.appendChild(alertDiv);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }

        function runMasterSync() {
            // Get CSRF token
            const csrftoken = getCSRFToken();

            // Get the sync button
            const syncButton = document.querySelector('button[onclick="runMasterSync()"]');
            const originalText = syncButton.innerHTML;

            // Disable button and show loading state
            syncButton.disabled = true;
            syncButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

            // Make AJAX request
            fetch('{% url "fasting:master_sync" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show detailed output in a modal
                    showSyncOutputModal(data.output, data.has_errors, data.auth_errors);
                } else {
                    showFlashMessage(data.message || 'Error running sync', false);
                    if (data.traceback) {
                        console.error('Sync error traceback:', data.traceback);
                    }
                }
            })
            .catch(error => {
                showFlashMessage('Network error: Could not run sync', false);
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable button and restore text
                syncButton.disabled = false;
                syncButton.innerHTML = originalText;
            });
        }

        function showSyncOutputModal(output, hasErrors, authErrors = {}) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('syncOutputModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'syncOutputModal';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Sync Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="authErrorsSection"></div>
                                <pre id="syncOutputContent" style="background-color: #f8f9fa; padding: 1rem; border-radius: 4px; max-height: 400px; overflow-y: auto;"></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Update modal content
            const outputContent = document.getElementById('syncOutputContent');
            outputContent.textContent = output;

            // Show authentication error section if there are auth errors
            const authErrorsSection = document.getElementById('authErrorsSection');
            if (authErrors && Object.keys(authErrors).length > 0) {
                let authHtml = '<div class="alert alert-warning mb-3"><strong>üîê Authentication Required</strong><br>';
                authHtml += 'Some services need re-authentication. Click below to authorize:<br><br>';

                if (authErrors.whoop) {
                    authHtml += '<a href="/oauth/whoop/authorize/" class="btn btn-sm btn-primary me-2">Re-authenticate Whoop</a>';
                }
                if (authErrors.withings) {
                    authHtml += '<a href="/oauth/withings/authorize/" class="btn btn-sm btn-primary me-2">Re-authenticate Withings</a>';
                }

                authHtml += '</div>';
                authErrorsSection.innerHTML = authHtml;
            } else {
                authErrorsSection.innerHTML = '';
            }

            // Change modal header color based on errors
            const modalHeader = modal.querySelector('.modal-header');
            if (hasErrors) {
                modalHeader.style.backgroundColor = '#fff3cd';
                modalHeader.querySelector('.modal-title').textContent = '‚ö†Ô∏è Sync Details (Some Errors)';
            } else {
                modalHeader.style.backgroundColor = '#d1e7dd';
                modalHeader.querySelector('.modal-title').textContent = '‚úì Sync Details (Success)';
            }

            // Show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Writing log functionality
        let currentWritingDate = null;
        const writingModal = new bootstrap.Modal(document.getElementById('writingModal'));

        // Show + icon on hover for empty write cells
        document.querySelectorAll('.write-cell').forEach(cell => {
            const icon = cell.querySelector('.add-writing-icon');
            if (icon) {
                cell.addEventListener('mouseenter', () => {
                    icon.style.display = 'inline-block';
                });
                cell.addEventListener('mouseleave', () => {
                    icon.style.display = 'none';
                });

                // Click on + icon to show modal
                icon.addEventListener('click', () => {
                    currentWritingDate = cell.dataset.date;
                    writingModal.show();
                });
            }
        });

        // Handle "Yes" button click in modal
        document.getElementById('confirmWritingBtn').addEventListener('click', function() {
            if (!currentWritingDate) return;

            const csrftoken = getCSRFToken();

            // Make AJAX request to create writing log
            fetch('{% url "writing:create_log" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    log_date: currentWritingDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    writingModal.hide();
                    showFlashMessage('Writing session logged successfully!');
                    // Refresh the page to show the checkmark
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    writingModal.hide();
                    showFlashMessage('Error: ' + (data.error || 'Unknown error'), false);
                }
            })
            .catch(error => {
                writingModal.hide();
                showFlashMessage('Network error: Could not save writing log', false);
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
