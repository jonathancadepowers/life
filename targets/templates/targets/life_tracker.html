{% load humanize %}
{% load tracker_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Life Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 3rem;
        }
        h1 {
            font-weight: 700;
            color: #212529;
            margin-bottom: 2rem;
        }
        h1 i {
            color: #0d6efd;
            margin-right: 0.5rem;
        }
        .date-selector {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .tracker-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .tracker-table table {
            margin-bottom: 0;
        }
        .tracker-table th {
            background-color: #0d6efd;
            color: white;
            font-weight: 600;
            padding: 1rem;
            border: none;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }
        .tracker-table th:last-child {
            border-right: none;
        }
        .tracker-table td {
            padding: 1rem;
            vertical-align: middle;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            height: 60px;
        }
        .tracker-table tbody tr {
            height: 60px;
        }
        .details-cell {
            position: relative;
            display: inline-block;
        }
        .details-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .details-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        .details-cell:hover .details-tooltip {
            opacity: 1;
        }
        .tracker-table td:last-child {
            border-right: none;
        }
        .tracker-table tbody tr:last-child td {
            border-bottom: none;
        }
        .tracker-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .tracker-table td.day-cell {
            font-weight: 600;
            color: #495057;
            text-align: left !important;
        }
        .date-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
        .checkbox-cell i {
            font-size: 1.5rem;
            color: #0d6efd;
        }
        .week-label {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        /* Tooltip styling for column headers */
        .tracker-table th {
            position: relative;
            cursor: help;
        }
        .tracker-table th[data-bs-toggle="tooltip"] {
            cursor: help;
        }
        /* Abandoned cell styling */
        .abandoned-cell {
            position: relative;
            opacity: 0.6;
        }
        .checkbox-cell {
            position: relative;
        }
    </style>
</head>
<body>
    <!-- Top Right Controls - Fixed Position -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; gap: 8px; align-items: center;">
        <button class="btn btn-warning btn-sm" onclick="runMasterSync()">
            <i class="bi bi-arrow-repeat"></i> Run Master Sync
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="navMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-list" style="font-size: 1.2rem;"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navMenuButton">
                <li><a class="dropdown-item active" href="/life-tracker/">Life Tracker</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/settings/">Settings</a></li>
                <li><a class="dropdown-item" href="/admin/">Admin</a></li>
            </ul>
        </div>
    </div>

    <div class="container mt-5">
        <h1 class="mb-4"><i class="bi bi-clipboard-check"></i>Life Tracker</h1>

        <!-- Week Selector Dropdown -->
        <div class="date-selector mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <select class="form-select" id="weekSelector" onchange="changeWeek(this.value)">
                        {% for week in available_weeks %}
                            <option value="{{ week.start_date }}" {% if week.selected %}selected{% endif %}>
                                {{ week.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary" onclick="goToThisWeek()">
                        <i class="bi bi-calendar-check"></i> This Week
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="goToLastWeek()">
                        <i class="bi bi-calendar-minus"></i> Last Week
                    </button>
                </div>
            </div>
        </div>

        <!-- Life Tracker Table -->
        <div class="tracker-table">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 20%; cursor: default;">
                            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.25rem;">
                                <i class="bi bi-brightness-high-fill" style="font-size: 1.5rem;"></i>
                                <span>Day (Date)</span>
                            </div>
                        </th>
                        {% for column in columns %}
                        <th style="width: {% widthratio 80 columns.count 1 %}%;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ column.tooltip_text }}">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <i class="bi {{ column.icon }}" style="font-size: 1.5rem;"></i>
                                <span>{{ column.display_name }}</span>
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in days %}
                    <tr>
                        <td class="day-cell">
                            {{ day.name }}
                            <span class="date-label">({{ day.date_str }})</span>
                        </td>
                        {% for column in columns %}
                        <td class="checkbox-cell{% if column.has_add_button %} add-btn-cell{% endif %}{% if column.allow_abandon %} abandon-enabled{% endif %}"
                            data-date="{{ day.date_iso }}"
                            data-column="{{ column.column_name }}"
                            data-modal-type="{{ column.modal_type }}"
                            data-endpoint="{{ column.create_endpoint }}">
                            {% with has_key="has_"|add:column.column_name details_key="details_"|add:column.column_name %}
                                {% if day|get_item:has_key %}
                                    <div class="details-cell">
                                        <i class="bi bi-check-square-fill"></i>
                                        {% with details_text=day|get_item:details_key %}
                                            {% if details_text %}
                                                <div class="details-tooltip">{{ details_text }}</div>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                {% elif column.has_add_button %}
                                    <i class="bi bi-plus-circle add-btn-icon" style="cursor: pointer; color: #6c757d; visibility: hidden; opacity: 0; transition: opacity 0.2s;"></i>
                                {% endif %}
                                {% if column.allow_abandon %}
                                    <i class="bi bi-flag-fill abandon-icon" style="cursor: pointer; color: #dc3545; visibility: hidden; opacity: 0; transition: opacity 0.2s; position: absolute; top: 2px; right: 5.5px; font-size: 0.75rem; z-index: 10; pointer-events: auto;"></i>
                                {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Generic Simple Confirm Modal -->
    <div class="modal fade" id="simpleConfirmModal" tabindex="-1" aria-labelledby="simpleConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="simpleConfirmModalLabel">Confirm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center d-flex align-items-center justify-content-center" style="min-height: 100px;">
                    <p class="fs-5 mb-0" id="simpleConfirmBodyText"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" id="confirmBtn">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Duration Select Modal (for fasting-type habits) -->
    <div class="modal fade" id="durationSelectModal" tabindex="-1" aria-labelledby="durationSelectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="durationSelectModalLabel">Select Duration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-center mb-3" id="durationSelectBodyText"></p>
                    <div class="row">
                        <div class="col-4">
                            <button class="btn btn-primary w-100 duration-btn" data-hours="12">
                                <i class="bi bi-clock"></i><br>12 Hours
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-success w-100 duration-btn" data-hours="16">
                                <i class="bi bi-clock"></i><br>16 Hours
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-info w-100 duration-btn" data-hours="18">
                                <i class="bi bi-clock"></i><br>18 Hours
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Value Input Modal (for measurements and other numeric inputs) -->
    <div class="modal fade" id="valueInputModal" tabindex="-1" aria-labelledby="valueInputModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="valueInputModalLabel">Enter Value</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-center mb-3" id="valueInputBodyText"></p>
                    <div class="mb-3">
                        <label for="valueInputField" class="form-label" id="valueInputFieldLabel">Value</label>
                        <input type="number" step="0.1" class="form-control" id="valueInputField" placeholder="Enter value">
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary btn-lg" id="valueInputSubmitBtn">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Abandon Day Modal -->
    <div class="modal fade" id="abandonModal" tabindex="-1" aria-labelledby="abandonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="abandonModalLabel">Mark Day as Abandoned</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center d-flex align-items-center justify-content-center" style="min-height: 100px;">
                    <p class="fs-5 mb-0" id="abandonModalText"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger btn-lg" id="abandonConfirmBtn">Abandon</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set user timezone cookie on page load for server-side use
        document.addEventListener('DOMContentLoaded', function() {
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.cookie = `user_timezone=${userTimezone}; path=/; max-age=31536000`; // 1 year
        });

        // Initialize Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

        // Helper functions
        function changeWeek(startDate) {
            window.location.href = '{% url "life_tracker" %}?start_date=' + startDate;
        }

        function goToThisWeek() {
            window.location.href = '{% url "life_tracker" %}';
        }

        function goToLastWeek() {
            // Get the second option in the dropdown (first is current week, second is last week)
            const selector = document.getElementById('weekSelector');
            if (selector.options.length > 1) {
                const lastWeekDate = selector.options[1].value;
                window.location.href = '{% url "life_tracker" %}?start_date=' + lastWeekDate;
            }
        }

        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        function showFlashMessage(message, isSuccess = true) {
            // Determine alert type based on message prefix or isSuccess
            let alertType = 'success';
            if (!isSuccess) {
                alertType = 'danger';
            } else if (message.startsWith('‚ö†Ô∏è')) {
                alertType = 'warning';
            }

            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${alertType} alert-dismissible fade show`;
            alertDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10001; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Add to page
            document.body.appendChild(alertDiv);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }

        function runMasterSync() {
            // Get CSRF token
            const csrftoken = getCSRFToken();

            // Get the sync button
            const syncButton = document.querySelector('button[onclick="runMasterSync()"]');
            const originalText = syncButton.innerHTML;

            // Disable button and show loading state
            syncButton.disabled = true;
            syncButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

            // Make AJAX request
            fetch('{% url "fasting:master_sync" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show detailed output in a modal
                    showSyncOutputModal(data.output, data.has_errors, data.auth_errors);
                } else {
                    showFlashMessage(data.message || 'Error running sync', false);
                    if (data.traceback) {
                        console.error('Sync error traceback:', data.traceback);
                    }
                }
            })
            .catch(error => {
                showFlashMessage('Network error: Could not run sync', false);
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable button and restore text
                syncButton.disabled = false;
                syncButton.innerHTML = originalText;
            });
        }

        function showSyncOutputModal(output, hasErrors, authErrors = {}) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('syncOutputModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'syncOutputModal';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Sync Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="authErrorsSection"></div>
                                <pre id="syncOutputContent" style="background-color: #f8f9fa; padding: 1rem; border-radius: 4px; max-height: 400px; overflow-y: auto;"></pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Update modal content
            const outputContent = document.getElementById('syncOutputContent');
            outputContent.textContent = output;

            // Show authentication error section if there are auth errors
            const authErrorsSection = document.getElementById('authErrorsSection');
            if (authErrors && Object.keys(authErrors).length > 0) {
                let authHtml = '<div class="alert alert-warning mb-3"><strong>üîê Authentication Required</strong><br>';
                authHtml += 'Some services need re-authentication. Click below to authorize:<br><br>';

                if (authErrors.whoop) {
                    authHtml += '<a href="/oauth/whoop/authorize/" class="btn btn-sm btn-primary me-2">Re-authenticate Whoop</a>';
                }
                if (authErrors.withings) {
                    authHtml += '<a href="/oauth/withings/authorize/" class="btn btn-sm btn-primary me-2">Re-authenticate Withings</a>';
                }

                authHtml += '</div>';
                authErrorsSection.innerHTML = authHtml;
            } else {
                authErrorsSection.innerHTML = '';
            }

            // Change modal header color based on errors
            const modalHeader = modal.querySelector('.modal-header');
            if (hasErrors) {
                modalHeader.style.backgroundColor = '#fff3cd';
                modalHeader.querySelector('.modal-title').textContent = '‚ö†Ô∏è Sync Details (Some Errors)';
            } else {
                modalHeader.style.backgroundColor = '#d1e7dd';
                modalHeader.querySelector('.modal-title').textContent = '‚úì Sync Details (Success)';
            }

            // Show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Helper function to check if a date is in the future
        function isFutureDate(dateStr) {
            const cellDate = new Date(dateStr + 'T00:00:00');
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

            // Get today's date in user's timezone
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA', { timeZone: userTimezone }); // YYYY-MM-DD format
            const today = new Date(todayStr + 'T00:00:00');

            return cellDate > today;
        }

        // Dynamic Add Button Functionality
        // Get modal configurations from database
        const columns = {{ columns_json|safe }};
        let currentModalDate = null;
        let currentModalEndpoint = null;
        let currentModalColumn = null;

        // Initialize modals
        const simpleConfirmModal = new bootstrap.Modal(document.getElementById('simpleConfirmModal'));
        const durationSelectModal = new bootstrap.Modal(document.getElementById('durationSelectModal'));
        const valueInputModal = new bootstrap.Modal(document.getElementById('valueInputModal'));

        // Show + icon on hover for all add-btn cells
        document.querySelectorAll('.add-btn-cell').forEach(cell => {
            const icon = cell.querySelector('.add-btn-icon');
            if (icon) {
                const cellDate = cell.dataset.date;

                // Don't show + icon for future dates
                if (isFutureDate(cellDate)) {
                    return;
                }

                cell.addEventListener('mouseenter', () => {
                    icon.style.visibility = 'visible';
                    icon.style.opacity = '1';
                });
                cell.addEventListener('mouseleave', () => {
                    icon.style.visibility = 'hidden';
                    icon.style.opacity = '0';
                });

                // Click on + icon to show appropriate modal
                icon.addEventListener('click', () => {
                    currentModalDate = cell.dataset.date;
                    currentModalEndpoint = cell.dataset.endpoint;
                    currentModalColumn = cell.dataset.column;
                    const modalType = cell.dataset.modalType;

                    // Find column config from columns data
                    const columnConfig = columns.find(c => c.column_name === currentModalColumn);
                    if (!columnConfig) return;

                    if (modalType === 'simple_confirm') {
                        // Set modal content
                        document.getElementById('simpleConfirmModalLabel').textContent = columnConfig.modal_title || 'Confirm';
                        document.getElementById('simpleConfirmBodyText').textContent = columnConfig.modal_body_text || 'Confirm this action?';
                        simpleConfirmModal.show();
                    } else if (modalType === 'duration_select') {
                        // Set modal content
                        document.getElementById('durationSelectModalLabel').textContent = columnConfig.modal_title || 'Select Duration';
                        document.getElementById('durationSelectBodyText').textContent = columnConfig.modal_body_text || 'Select duration:';
                        durationSelectModal.show();
                    } else if (modalType === 'value_input') {
                        // Set modal content
                        document.getElementById('valueInputModalLabel').textContent = columnConfig.modal_title || 'Enter Value';
                        document.getElementById('valueInputBodyText').textContent = columnConfig.modal_body_text || 'Enter a value:';
                        document.getElementById('valueInputFieldLabel').textContent = columnConfig.modal_input_label || 'Value';
                        // Clear previous input
                        document.getElementById('valueInputField').value = '';
                        valueInputModal.show();
                    }
                });
            }
        });

        // Handle simple confirm modal "Yes" button
        document.getElementById('confirmBtn').addEventListener('click', function() {
            if (!currentModalDate || !currentModalEndpoint) return;

            const csrftoken = getCSRFToken();

            // Make AJAX request
            fetch('/' + currentModalEndpoint.replace(':', '/'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    log_date: currentModalDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    simpleConfirmModal.hide();
                    showFlashMessage('Successfully logged!');

                    // Find the cell and update it to show checkmark
                    const cell = document.querySelector(
                        `.checkbox-cell[data-date="${currentModalDate}"][data-column="${currentModalColumn}"]`
                    );
                    if (cell) {
                        // Add checkmark HTML
                        cell.innerHTML = '<div class="details-cell"><i class="bi bi-check-square-fill"></i></div>';
                        // Remove the add-btn-cell class to hide the + button
                        cell.classList.remove('add-btn-cell');
                    }
                } else {
                    simpleConfirmModal.hide();
                    showFlashMessage('Error: ' + (data.error || data.message || 'Unknown error'), false);
                }
            })
            .catch(error => {
                simpleConfirmModal.hide();
                showFlashMessage('Network error: Could not save', false);
                console.error('Error:', error);
            });
        });

        // Handle duration select modal button clicks
        document.querySelectorAll('.duration-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!currentModalDate || !currentModalEndpoint) return;

                const hours = this.dataset.hours;
                const csrftoken = getCSRFToken();

                // Disable all buttons during submission
                document.querySelectorAll('.duration-btn').forEach(b => {
                    b.disabled = true;
                    b.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Logging...';
                });

                // Make AJAX request
                fetch('/' + currentModalEndpoint.replace(':', '/'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: `hours=${hours}&date=${currentModalDate}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        durationSelectModal.hide();
                        showFlashMessage('Successfully logged!');

                        // Find the cell and update it to show checkmark
                        const cell = document.querySelector(
                            `.checkbox-cell[data-date="${currentModalDate}"][data-column="${currentModalColumn}"]`
                        );
                        if (cell) {
                            // Add checkmark HTML with duration if provided
                            const details = data.duration ? `<div class="details-tooltip">${data.duration} hours</div>` : '';
                            cell.innerHTML = `<div class="details-cell"><i class="bi bi-check-square-fill"></i>${details}</div>`;
                            // Remove the add-btn-cell class to hide the + button
                            cell.classList.remove('add-btn-cell');
                        }
                    } else {
                        durationSelectModal.hide();
                        showFlashMessage('Error: ' + (data.message || data.error || 'Unknown error'), false);
                    }
                })
                .catch(error => {
                    durationSelectModal.hide();
                    showFlashMessage('Network error: Could not save', false);
                    console.error('Error:', error);
                })
                .finally(() => {
                    // Re-enable buttons and restore text
                    const buttonTexts = {
                        '12': '<i class="bi bi-clock"></i><br>12 Hours',
                        '16': '<i class="bi bi-clock"></i><br>16 Hours',
                        '18': '<i class="bi bi-clock"></i><br>18 Hours'
                    };

                    document.querySelectorAll('.duration-btn').forEach((b) => {
                        b.disabled = false;
                        const hours = b.dataset.hours;
                        b.innerHTML = buttonTexts[hours];
                    });
                });
            });
        });

        // Handle value input modal submit button
        document.getElementById('valueInputSubmitBtn').addEventListener('click', function() {
            if (!currentModalDate || !currentModalEndpoint) return;

            const inputValue = document.getElementById('valueInputField').value;

            // Validate input
            if (!inputValue || inputValue.trim() === '') {
                showFlashMessage('Please enter a value', false);
                return;
            }

            const csrftoken = getCSRFToken();

            // Disable button during submission
            const submitBtn = this;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

            // Make AJAX request
            fetch('/' + currentModalEndpoint.replace(':', '/'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    log_date: currentModalDate,
                    input_value: parseFloat(inputValue)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    valueInputModal.hide();
                    showFlashMessage(data.message || 'Successfully logged!');

                    // Find the cell and update it to show checkmark
                    const cell = document.querySelector(
                        `.checkbox-cell[data-date="${currentModalDate}"][data-column="${currentModalColumn}"]`
                    );
                    if (cell) {
                        // Add checkmark HTML
                        cell.innerHTML = '<div class="details-cell"><i class="bi bi-check-square-fill"></i></div>';
                        // Remove the add-btn-cell class to hide the + button
                        cell.classList.remove('add-btn-cell');
                    }
                } else {
                    valueInputModal.hide();
                    showFlashMessage('Error: ' + (data.message || data.error || 'Unknown error'), false);
                }
            })
            .catch(error => {
                valueInputModal.hide();
                showFlashMessage('Network error: Could not save', false);
                console.error('Error:', error);
            })
            .finally(() => {
                // Re-enable button and restore text
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit';
            });
        });

        // Abandon icon hover and click handling
        const abandonModal = new bootstrap.Modal(document.getElementById('abandonModal'));
        let currentAbandonDate = null;
        let currentAbandonColumn = null;

        // Set up abandon icon visibility and click handlers
        console.log('Setting up abandon icons...');
        document.querySelectorAll('.abandon-enabled').forEach(cell => {
            const abandonIcon = cell.querySelector('.abandon-icon');
            console.log('Found cell:', cell, 'Icon:', abandonIcon);
            if (abandonIcon) {
                const cellDate = cell.dataset.date;
                const columnName = cell.dataset.column;

                // Find the column configuration
                const columnConfig = columns.find(col => col.column_name === columnName);
                console.log('Column config:', columnConfig);
                if (!columnConfig || !columnConfig.allow_abandon) return;

                // Check if this date is abandoned
                const isAbandoned = columnConfig.abandoned_status && columnConfig.abandoned_status[cellDate];

                // If abandoned, show the icon always and change its appearance
                if (isAbandoned) {
                    abandonIcon.style.visibility = 'visible';
                    abandonIcon.style.opacity = '0.5';
                    cell.classList.add('abandoned-cell');
                }

                // Show/hide icon on hover
                cell.addEventListener('mouseenter', () => {
                    abandonIcon.style.visibility = 'visible';
                    abandonIcon.style.opacity = isAbandoned ? '0.5' : '1';
                });
                cell.addEventListener('mouseleave', () => {
                    if (!isAbandoned) {
                        abandonIcon.style.visibility = 'hidden';
                        abandonIcon.style.opacity = '0';
                    }
                });

                // Handle abandon icon click
                abandonIcon.addEventListener('click', (e) => {
                    console.log('Abandon icon clicked!', cellDate, columnName);
                    e.stopPropagation();
                    e.preventDefault();

                    currentAbandonDate = cellDate;
                    currentAbandonColumn = columnName;

                    // Get column display name
                    const displayName = columnConfig.display_name;

                    // Format date for display
                    const date = new Date(cellDate);
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

                    // Update modal text based on whether it's already abandoned
                    const modalText = document.getElementById('abandonModalText');
                    const confirmBtn = document.getElementById('abandonConfirmBtn');

                    // Check current abandoned status at click time
                    const currentlyAbandoned = columnConfig.abandoned_status && columnConfig.abandoned_status[cellDate];

                    if (currentlyAbandoned) {
                        modalText.textContent = `Un-abandon ${dateStr} for ${displayName}?`;
                        confirmBtn.textContent = 'Un-abandon';
                        confirmBtn.classList.remove('btn-danger');
                        confirmBtn.classList.add('btn-primary');
                    } else {
                        modalText.textContent = `Mark ${dateStr} as abandoned for ${displayName}?`;
                        confirmBtn.textContent = 'Abandon';
                        confirmBtn.classList.remove('btn-primary');
                        confirmBtn.classList.add('btn-danger');
                    }

                    abandonModal.show();
                });
            }
        });

        // Handle abandon confirmation
        document.getElementById('abandonConfirmBtn').addEventListener('click', function() {
            if (!currentAbandonDate || !currentAbandonColumn) return;

            const csrftoken = getCSRFToken();

            fetch(`/settings/habits/${currentAbandonColumn}/toggle-abandon/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    date: currentAbandonDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    abandonModal.hide();

                    // Find the cell and update it
                    const cell = document.querySelector(
                        `.checkbox-cell[data-date="${currentAbandonDate}"][data-column="${currentAbandonColumn}"]`
                    );
                    if (cell) {
                        const abandonIcon = cell.querySelector('.abandon-icon');

                        if (data.is_abandoned) {
                            // Mark as abandoned
                            cell.classList.add('abandoned-cell');
                            if (abandonIcon) {
                                abandonIcon.style.visibility = 'visible';
                                abandonIcon.style.opacity = '0.5';
                            }
                            showFlashMessage('Day marked as abandoned');
                        } else {
                            // Un-abandon
                            cell.classList.remove('abandoned-cell');
                            if (abandonIcon) {
                                abandonIcon.style.visibility = 'hidden';
                                abandonIcon.style.opacity = '0';
                            }
                            showFlashMessage('Day un-abandoned');
                        }

                        // Update the column configuration for this session
                        const columnConfig = columns.find(col => col.column_name === currentAbandonColumn);
                        if (columnConfig) {
                            if (!columnConfig.abandoned_status) {
                                columnConfig.abandoned_status = {};
                            }
                            columnConfig.abandoned_status[currentAbandonDate] = data.is_abandoned;
                        }
                    }
                } else {
                    abandonModal.hide();
                    showFlashMessage('Error: ' + (data.error || 'Unknown error'), false);
                }
            })
            .catch(error => {
                abandonModal.hide();
                showFlashMessage('Network error: Could not update', false);
                console.error('Error:', error);
            });
        });

        // Streak detection - replace checkmarks with fire icons for 3+ consecutive days
        function detectAndShowStreaks() {
            // Get all table rows (7 days of the week)
            const rows = document.querySelectorAll('tbody tr');
            if (rows.length === 0) return;

            // Get all columns
            const firstRow = rows[0];
            const cells = firstRow.querySelectorAll('.checkbox-cell');
            const numColumns = cells.length;

            // For each column, check for streaks
            for (let colIndex = 0; colIndex < numColumns; colIndex++) {
                const columnCells = [];

                // Collect all cells in this column (one per day)
                rows.forEach(row => {
                    const cell = row.querySelectorAll('.checkbox-cell')[colIndex];
                    if (cell) {
                        columnCells.push(cell);
                    }
                });

                // Detect streaks in this column
                let currentStreak = [];
                const streaks = [];

                for (let dayIndex = 0; dayIndex < columnCells.length; dayIndex++) {
                    const cell = columnCells[dayIndex];
                    const hasCheckmark = cell.querySelector('.bi-check-square-fill') !== null;

                    if (hasCheckmark) {
                        currentStreak.push(dayIndex);
                    } else {
                        // Streak broken - save it if it's 3+ days
                        if (currentStreak.length >= 3) {
                            streaks.push([...currentStreak]);
                        }
                        currentStreak = [];
                    }
                }

                // Don't forget the last streak if it goes to the end of the week
                if (currentStreak.length >= 3) {
                    streaks.push([...currentStreak]);
                }

                // Replace checkmarks with fire icons for all streaks
                streaks.forEach(streak => {
                    streak.forEach(dayIndex => {
                        const cell = columnCells[dayIndex];
                        const checkmark = cell.querySelector('.bi-check-square-fill');

                        if (checkmark) {
                            // Replace with fire icon
                            checkmark.className = 'bi bi-fire';
                            checkmark.style.color = '#ff6b6b';
                            checkmark.style.fontSize = '1.5rem';
                        }
                    });
                });
            }
        }

        // Run streak detection after page loads
        document.addEventListener('DOMContentLoaded', function() {
            detectAndShowStreaks();
        });
    </script>
</body>
</html>
