{% load humanize %}
{% load targets_filters %}
{% load tz %}
{% timezone user_timezone %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Activity report and analytics">
    <meta name="keywords" content="activity, report, analytics">
    <title>Activity Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 3rem;
        }
        .edit-objective-btn,
        .delete-objective-btn {
            text-decoration: none;
        }
        .report-card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            height: 100%;
        }
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0d6efd;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .card-icon {
            font-size: 2.5rem;
            opacity: 0.2;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        .date-selector {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #495057;
        }
        h1 {
            font-weight: 700;
            color: #212529;
        }
        .week-label {
            color: #6c757d;
            font-size: 1.1rem;
        }
        .positive-change {
            color: #198754;
        }
        .negative-change {
            color: #dc3545;
        }
        .section-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
            border-bottom: 3px solid #0d6efd;
            padding-bottom: 0.5rem;
            margin-bottom: 0;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        .section-header:hover {
            background-color: rgba(13, 110, 253, 0.05);
            padding-left: 0.5rem;
        }
        .section-header i {
            color: #0d6efd;
        }
        .section-header .chevron {
            float: right;
            transition: transform 0.3s;
        }
        .section-header[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }
        .section-header-objectives {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
            border-bottom: 3px solid #dc3545;
            padding-bottom: 0.5rem;
            margin-bottom: 0;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        .section-header-objectives:hover {
            background-color: rgba(220, 53, 69, 0.05);
            padding-left: 0.5rem;
        }
        .section-header-objectives i {
            color: #dc3545;
        }
        .section-header-objectives .chevron {
            float: right;
            transition: transform 0.3s;
        }
        .section-header-objectives[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }
        .section-header-activity {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
            border-bottom: 3px solid #198754;
            padding-bottom: 0.5rem;
            margin-bottom: 0;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        .section-header-activity:hover {
            background-color: rgba(25, 135, 84, 0.05);
            padding-left: 0.5rem;
        }
        .section-header-activity i {
            color: #198754;
        }
        .section-header-activity .chevron {
            float: right;
            transition: transform 0.3s;
        }
        .section-header-activity[aria-expanded="true"] .chevron {
            transform: rotate(180deg);
        }
        .goal-breakdown {
            margin-top: 0.5rem;
            padding-left: 1rem;
            border-left: 3px solid #0dcaf0;
            background: rgba(13, 202, 240, 0.05);
            padding: 0.5rem 0.5rem 0.5rem 1rem;
            border-radius: 4px;
        }
        .goal-item {
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        .project-bar {
            background: linear-gradient(90deg, #0d6efd 0%, #0dcaf0 100%);
            height: 24px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-weight: 500;
        }
        .deprecation-banner {
            border-radius: 0;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 1.5rem;
        }
        .flash-message-container {
            position: fixed;
            top: 20px;
            right: 70px;
            z-index: 9999;
            max-width: 400px;
        }
        .top-right-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .nav-menu-icon {
            font-size: 1.2rem;
        }
        .date-picker-inline {
            width: auto;
            display: inline-block;
        }
        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
        }
        .objectives-month-label {
            font-size: 0.85rem;
        }
        .th-category {
            width: 120px;
        }
        .th-objective {
            white-space: nowrap;
        }
        .th-target {
            width: 140px;
            padding-right: 30px;
            white-space: nowrap;
        }
        .th-current {
            width: 80px;
            padding-right: 30px;
        }
        .th-today {
            width: 80px;
            padding-right: 30px;
        }
        .th-progress {
            width: 250px;
        }
        .th-actions {
            width: 80px;
        }
        .objective-row {
            height: 45px;
        }
        .cell-padded-right {
            padding-right: 30px;
        }
        .progress-label {
            position: absolute;
            left: 5px;
            top: 2px;
            font-size: 0.75rem;
        }
        .vertical-label {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            align-self: center;
        }
        .total-row-divider {
            border-top: 2px solid #dee2e6;
        }
        .form-info-icon {
            cursor: help;
            font-size: 0.8rem;
            opacity: 0.6;
            color: #0d6efd;
        }
        .initially-hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Deprecation Banner -->
    <div class="alert alert-danger text-center mb-0 deprecation-banner" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> This page has been deprecated and is no longer in use.
    </div>

    <!-- Flash Message Container -->
    <div id="flashMessageContainer" class="container mt-4 flash-message-container"></div>

    <!-- Top Right Controls - Fixed Position -->
    <div class="top-right-controls">
        <button class="btn btn-warning btn-sm" onclick="runMasterSync()">
            <i class="bi bi-arrow-repeat"></i> Run Master Sync
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm" type="button" id="navMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-list nav-menu-icon"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navMenuButton">
                <li><a class="dropdown-item" href="/activity-logger/">Activity Logger</a></li>
                <li><a class="dropdown-item active" href="/activity-report/">Activity Report</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/admin/">Admin</a></li>
            </ul>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="mb-3">
                    <h1><i class="bi bi-graph-up-arrow"></i> Activity Report</h1>
                </div>
                <div class="d-flex align-items-center flex-wrap gap-2">
                    <input type="date" class="form-control form-control-sm date-picker-inline" id="start_date"
                           value="{{ start_date|date:'Y-m-d' }}">
                    <span class="week-label">-</span>
                    <input type="date" class="form-control form-control-sm date-picker-inline" id="end_date"
                           value="{{ end_date|date:'Y-m-d' }}">
                    <select class="form-select form-select-sm ms-2 date-picker-inline" id="quick_date_picker">
                        <option value="">Jump To Date</option>
                        <option value="today">Today</option>
                        <option value="this_month" id="this_month_option"></option>
                        <option value="next_month" id="next_month_option"></option>
                        <option value="next_next_month" id="next_next_month_option"></option>
                        <option value="this_quarter" id="this_quarter_option"></option>
                        <option value="this_year" id="this_year_option"></option>
                    </select>
                    <span class="badge bg-primary ms-2">{{ days_in_range }} days</span>
                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="loading-spinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Activity Section -->
        <div class="row mt-5 mb-3">
            <div class="col-12">
                <h3 class="section-header-activity" data-bs-toggle="collapse" data-bs-target="#todaysActivitySection" aria-expanded="false" aria-controls="todaysActivitySection">
                    <i class="bi bi-calendar-check"></i> Today's Activity
                    <i class="bi bi-chevron-down chevron"></i>
                </h3>
            </div>
        </div>

        <div id="todaysActivitySection" class="collapse">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <style>
                                .activity-section-wrapper {
                                    display: flex;
                                    align-items: center;
                                    gap: 20px;
                                }
                                .activity-pill {
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 12px 20px;
                                    margin: 6px;
                                    border-radius: 12px;
                                    background: #f8f9fa;
                                    border: 2px solid;
                                    font-size: 1rem;
                                    font-weight: 500;
                                    color: #2c3e50;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                                    transition: all 0.2s ease;
                                    cursor: help;
                                    position: relative;
                                }
                                .activity-pill:hover {
                                    transform: translateY(-2px);
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                                    background: #ffffff;
                                }
                                .activity-pill i {
                                    font-size: 1.5rem;
                                }
                                /* Colored borders for each activity type */
                                .activity-pill-workouts {
                                    border-color: #212529;
                                }
                                .activity-pill-workouts i {
                                    color: #212529;
                                }
                                .activity-pill-fasting {
                                    border-color: #212529;
                                }
                                .activity-pill-fasting i {
                                    color: #212529;
                                }
                                .activity-pill-nutrition {
                                    border-color: #212529;
                                }
                                .activity-pill-nutrition i {
                                    color: #212529;
                                }
                                .activity-pill-weight {
                                    border-color: #212529;
                                }
                                .activity-pill-weight i {
                                    color: #212529;
                                }
                                .activity-pill-time {
                                    border-color: #212529;
                                }
                                .activity-pill-time i {
                                    color: #212529;
                                }
                                .activity-pills-container {
                                    display: flex;
                                    flex-wrap: wrap;
                                    gap: 4px;
                                    flex: 1;
                                }
                                .activity-date-label {
                                    font-size: 0.75rem;
                                    font-weight: 600;
                                    color: #6c757d;
                                    writing-mode: vertical-rl;
                                    transform: rotate(180deg);
                                    padding-right: 12px;
                                    display: flex;
                                    align-items: center;
                                    letter-spacing: 0.5px;
                                    position: relative;
                                    top: 2px;
                                }
                                /* Tooltip styling */
                                .activity-pill::after {
                                    content: attr(data-tooltip);
                                    position: absolute;
                                    bottom: 100%;
                                    left: 50%;
                                    transform: translateX(-50%) translateY(-8px);
                                    background: rgba(0, 0, 0, 0.9);
                                    color: white;
                                    padding: 10px 14px;
                                    border-radius: 6px;
                                    font-size: 0.85rem;
                                    white-space: pre;
                                    opacity: 0;
                                    pointer-events: none;
                                    transition: opacity 0.2s ease;
                                    z-index: 1000;
                                    text-align: left;
                                }
                                .activity-pill:hover::after {
                                    opacity: 1;
                                }
                            </style>

                            <div class="activity-section-wrapper">
                                {% if todays_activity.workouts or todays_activity.time_logs or todays_activity.fasts or todays_activity.nutrition or todays_activity.weighins %}
                                <div class="activity-date-label">{{ today|date:"M d"|upper }}</div>
                                {% endif %}
                                <div class="activity-pills-container">
                                <!-- Workouts -->
                                {% if todays_activity.workouts %}
                                    {% for workout in todays_activity.workouts %}
                                    {% with sport_name=todays_activity.sport_names|get_item:workout.sport_id|default:"Workout" %}
                                    <div class="activity-pill activity-pill-workouts"
                                         data-tooltip="{{ sport_name }} • {{ workout.start|date:'g:i A' }}-{{ workout.end|date:'g:i A' }}{% if workout.calories_burned %} • {{ workout.calories_burned|floatformat:0 }} cal{% endif %}{% if workout.average_heart_rate %} • {{ workout.average_heart_rate|floatformat:0 }} bpm avg{% endif %}">
                                        <i class="bi bi-lightning-charge-fill"></i>
                                        <span>{% if "Running" in sport_name %}Ran{% elif "Cycling" in sport_name %}Cycled{% elif "Swimming" in sport_name %}Swam{% elif "Walking" in sport_name %}Walked{% elif "Functional Fitness" in sport_name %}Trained{% elif "Weightlifting" in sport_name or "Weight Training" in sport_name %}Lifted{% elif "Sauna" in sport_name %}Sauna{% else %}Worked Out{% endif %} {{ workout.duration_minutes|floatformat:0 }} min</span>
                                    </div>
                                    {% endwith %}
                                    {% endfor %}
                                {% endif %}

                                <!-- Fasts -->
                                {% if todays_activity.fasts %}
                                    {% for fast in todays_activity.fasts %}
                                    <div class="activity-pill activity-pill-fasting"
                                         data-tooltip="Completed {{ fast.duration|floatformat:1 }}-hour fast (ended {{ fast.fast_end_date|date:'g:i A' }})">
                                        <i class="bi bi-hourglass-split"></i>
                                        <span>Fasted {{ fast.duration|floatformat:0 }}h</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Nutrition -->
                                {% if todays_activity.nutrition %}
                                    {% for entry in todays_activity.nutrition %}
                                    <div class="activity-pill activity-pill-nutrition"
                                         data-tooltip="{{ entry.consumption_date|date:'g:i A' }}{% if entry.protein or entry.carbs or entry.fat %} • P:{{ entry.protein|floatformat:0 }}g C:{{ entry.carbs|floatformat:0 }}g F:{{ entry.fat|floatformat:0 }}g{% endif %}">
                                        <i class="bi bi-egg-fried"></i>
                                        <span>Consumed {{ entry.calories|floatformat:0 }} cal</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Weigh-ins -->
                                {% if todays_activity.weighins %}
                                    {% for weighin in todays_activity.weighins %}
                                    <div class="activity-pill activity-pill-weight"
                                         data-tooltip="Weighed {{ weighin.weight|floatformat:1 }} lbs at {{ weighin.measurement_time|date:'g:i A' }}">
                                        <i class="bi bi-speedometer2"></i>
                                        <span>Weighed {{ weighin.weight|floatformat:1 }} lbs</span>
                                    </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Time Worked Pill -->
                                {% if todays_activity.time_logs %}
                                <div class="activity-pill activity-pill-time" id="timeWorkedPill" data-tooltip="">
                                    <i class="bi bi-clock-fill"></i>
                                    <span id="timeWorkedText"></span>
                                </div>
                                {% endif %}
                                </div>
                            </div>

                            <script>
                            // Calculate total time worked and build tooltip
                            (function() {
                                const timeLogs = {{ todays_activity.time_logs_json|safe }};
                                if (!timeLogs || timeLogs.length === 0) return;

                                // Group time by project
                                const projectTime = {};
                                let totalTime = 0;

                                timeLogs.forEach(log => {
                                    const projectName = log.project || 'Uncategorized';
                                    const duration = log.duration / 3600; // Convert seconds to hours
                                    projectTime[projectName] = (projectTime[projectName] || 0) + duration;
                                    totalTime += duration;
                                });

                                // Sort projects by time (descending)
                                const sortedProjects = Object.entries(projectTime)
                                    .sort((a, b) => b[1] - a[1]);

                                // Set pill text
                                document.getElementById('timeWorkedText').textContent =
                                    `Worked ${totalTime.toFixed(1)}h`;

                                // Build tooltip as plain text
                                let tooltipText = '';
                                sortedProjects.forEach(([project, hours], index) => {
                                    if (index > 0) tooltipText += '\n';
                                    tooltipText += `${project}: ${hours.toFixed(1)}h`;
                                });

                                document.getElementById('timeWorkedPill').setAttribute('data-tooltip', tooltipText);
                            })();
                            </script>

                            <!-- Empty state -->
                            {% if not todays_activity.workouts and not todays_activity.time_logs and not todays_activity.fasts and not todays_activity.nutrition and not todays_activity.weighins %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-inbox empty-state-icon"></i>
                                <p class="mt-2">No activity recorded for today yet.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Objectives Section -->
        <div class="row mt-5 mb-3">
            <div class="col-12">
                <h3 class="section-header-objectives" data-bs-toggle="collapse" data-bs-target="#monthlyObjectivesSection" aria-expanded="false" aria-controls="monthlyObjectivesSection">
                    <i class="bi bi-bullseye"></i> Monthly Objectives
                    <i class="bi bi-chevron-down chevron"></i>
                </h3>
            </div>
        </div>

        <div id="monthlyObjectivesSection" class="collapse">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            {% if monthly_objectives.crosses_months %}
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i> Your selected date range crosses multiple months. Showing objectives for <strong>{{ monthly_objectives.target_month }}</strong>.
                            </div>
                            {% endif %}

                            {% if monthly_objectives.objectives %}
                            <div class="mb-3 d-flex justify-content-between align-items-center">
                                <div class="text-muted objectives-month-label">
                                    <strong>{{ monthly_objectives.target_month }}</strong>
                                </div>
                                <div>
                                    <a href="#" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#createObjectiveModal">
                                        <i class="bi bi-plus-circle"></i> Create Objective
                                    </a>
                                </div>
                            </div>

                            <!-- Simple table with all objectives -->
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th class="th-category">Category</th>
                                            <th class="th-objective">Objective</th>
                                            <th></th>
                                            <th class="text-center th-target">Target</th>
                                            <th class="text-center th-current">Current</th>
                                            <th class="text-center th-today">Today</th>
                                            <th class="th-progress">Progress</th>
                                            <th class="th-actions"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in monthly_objectives.all_categories %}
                                            {% with objectives=monthly_objectives.objectives_by_category|get_item:category %}
                                            {% if objectives %}
                                            {% for objective in objectives %}
                                            <tr class="objective-row">
                                                {% if forloop.first %}
                                                <td class="align-middle" rowspan="{{ objectives|length }}">{{ category }}</td>
                                                {% endif %}
                                                <td class="align-middle text-nowrap">
                                                    {{ objective.label }}
                                                    {% if objective.description %}
                                                    <i class="bi bi-info-circle ms-1"
                                                       style="cursor: help; font-size: 0.6rem; opacity: 0.4; color: #6c757d;"
                                                       data-bs-toggle="tooltip"
                                                       data-bs-placement="right"
                                                       title="{{ objective.description }}"></i>
                                                    {% endif %}
                                                </td>
                                                <td></td>
                                                <td class="text-center align-middle cell-padded-right"
                                                    style="cursor: help;"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="top"
                                                    title="Target/week = {{ objective.target_per_week|floatformat:1 }}">{{ objective.target|floatformat:0 }}{% if objective.unit %} {{ objective.unit }}{% endif %}</td>
                                                <td class="text-center align-middle cell-padded-right">
                                                    {{ objective.result|floatformat:0 }}
                                                    {% if not objective.objective_definition|upper|slice:":4" == "WITH" %}
                                                    <i class="bi bi-info-circle-fill ms-1 objective-detail-icon"
                                                       style="cursor: pointer; font-size: 0.75rem; opacity: 0.6; color: #0d6efd;"
                                                       data-objective-id="{{ objective.objective_id }}"
                                                       title="View details"></i>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center align-middle cell-padded-right">{{ objective.today_result|floatformat:0 }}</td>
                                                <td class="align-middle">
                                                    <!-- Linear progress indicator with marker -->
                                                    <div style="position: relative; height: 20px; background: {% if objective.achieved %}#d4edda{% else %}#e9ecef{% endif %}; border-radius: 3px;">
                                                        <div style="position: absolute; left: {% if objective.progress_pct > 100 %}100{% else %}{{ objective.progress_pct }}{% endif %}%; top: 0; width: 2px; height: 20px; background: {% if objective.achieved %}#198754{% else %}#6c757d{% endif %};"></div>
                                                        <span class="progress-label">{{ objective.progress_pct }}%</span>
                                                    </div>
                                                </td>
                                                <td class="text-end">
                                                    <a href="#" class="text-primary edit-objective-btn me-2"
                                                       data-objective-id="{{ objective.objective_id }}"
                                                       data-label="{{ objective.label }}"
                                                       data-month="{{ objective.start|date:'n' }}"
                                                       data-year="{{ objective.start|date:'Y' }}"
                                                       data-target="{{ objective.objective_value }}"
                                                       data-definition="{{ objective.objective_definition }}"
                                                       data-category="{{ objective.category|default:'' }}"
                                                       data-description="{{ objective.description|default:'' }}"
                                                       data-unit="{{ objective.unit|default:'' }}"
                                                       data-historical-display="{{ objective.historical_display|default:'' }}"
                                                       title="Edit objective">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <a href="#" class="text-danger delete-objective-btn"
                                                       data-objective-id="{{ objective.objective_id }}"
                                                       data-label="{{ objective.label }}"
                                                       title="Delete objective">
                                                        <i class="bi bi-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            {% endif %}
                                            {% endwith %}
                                        {% endfor %}

                                        {% for objective in monthly_objectives.uncategorized %}
                                        <tr class="objective-row">
                                            <td class="text-secondary align-middle">—</td>
                                            <td class="align-middle text-nowrap">
                                                {{ objective.label }}
                                                {% if objective.description %}
                                                <i class="bi bi-info-circle ms-1"
                                                   style="cursor: help; font-size: 0.6rem; opacity: 0.4; color: #6c757d;"
                                                   data-bs-toggle="tooltip"
                                                   data-bs-placement="right"
                                                   title="{{ objective.description }}"></i>
                                                {% endif %}
                                            </td>
                                            <td></td>
                                            <td class="text-center align-middle cell-padded-right"
                                                style="cursor: help;"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Target/week = {{ objective.target_per_week|floatformat:1 }}">{{ objective.target|floatformat:0 }}{% if objective.unit %} {{ objective.unit }}{% endif %}</td>
                                            <td class="text-center align-middle cell-padded-right">
                                                {{ objective.result|floatformat:0 }}
                                                {% if not objective.objective_definition|upper|slice:":4" == "WITH" %}
                                                <i class="bi bi-info-circle-fill ms-1 objective-detail-icon"
                                                   style="cursor: pointer; font-size: 0.75rem; opacity: 0.6; color: #0d6efd;"
                                                   data-objective-id="{{ objective.objective_id }}"
                                                   title="View details"></i>
                                                {% endif %}
                                            </td>
                                            <td class="text-center align-middle cell-padded-right">{{ objective.today_result|floatformat:0 }}</td>
                                            <td class="align-middle">
                                                <!-- Linear progress indicator with marker -->
                                                <div style="position: relative; height: 20px; background: {% if objective.achieved %}#d4edda{% else %}#e9ecef{% endif %}; border-radius: 3px;">
                                                    <div style="position: absolute; left: {% if objective.progress_pct > 100 %}100{% else %}{{ objective.progress_pct }}{% endif %}%; top: 0; width: 2px; height: 20px; background: {% if objective.achieved %}#198754{% else %}#6c757d{% endif %};"></div>
                                                    <span class="progress-label">{{ objective.progress_pct }}%</span>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <a href="#" class="text-primary edit-objective-btn me-2"
                                                   data-objective-id="{{ objective.objective_id }}"
                                                   data-label="{{ objective.label }}"
                                                   data-month="{{ objective.start|date:'n' }}"
                                                   data-year="{{ objective.start|date:'Y' }}"
                                                   data-target="{{ objective.objective_value }}"
                                                   data-definition="{{ objective.objective_definition }}"
                                                   data-category="{{ objective.category|default:'' }}"
                                                   data-description="{{ objective.description|default:'' }}"
                                                   data-unit="{{ objective.unit|default:'' }}"
                                                   title="Edit objective">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <a href="#" class="text-danger delete-objective-btn"
                                                   data-objective-id="{{ objective.objective_id }}"
                                                   data-label="{{ objective.label }}"
                                                   title="Delete objective">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-secondary">
                                <i class="bi bi-calendar-x"></i> No monthly objectives found for {{ monthly_objectives.target_month }}.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nutrition & Weight Section -->
        <div class="row mt-5 mb-3">
            <div class="col-12">
                <h3 class="section-header" data-bs-toggle="collapse" data-bs-target="#foodWeightSection" aria-expanded="false" aria-controls="foodWeightSection">
                    <i class="bi bi-apple"></i> Nutrition & Weight
                    <i class="bi bi-chevron-down chevron"></i>
                </h3>
            </div>
        </div>

        <div id="foodWeightSection" class="collapse">
        <div class="row g-4">
            <!-- Fasting Card -->
            {% if fasting.count > 0 %}
            <div class="col-md-6 col-lg-4">
                <div class="card report-card">
                    <i class="bi bi-hourglass-split card-icon"></i>
                    <div class="card-body position-relative">
                        <div class="section-title">
                            <i class="bi bi-hourglass-split text-warning"></i> Fasting
                        </div>
                        <div class="stat-value">{{ fasting.count }}</div>
                        <div class="stat-label">Fasts Completed</div>

                        <hr>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Fasts this Year:</span>
                                <span>{{ fasting.year_count }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">% Days Fasted:</span>
                                <span>{{ fasting.percent_days_fasted }}%</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Avg Duration:</span>
                                <span>{{ fasting.avg_duration|floatformat:1 }}h</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Longest:</span>
                                <span>{{ fasting.max_duration|floatformat:1 }}h</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Nutrition Card -->
            {% if nutrition.days_tracked > 0 %}
            <div class="col-md-6 col-lg-4">
                <div class="card report-card">
                    <i class="bi bi-egg-fried card-icon"></i>
                    <div class="card-body position-relative">
                        <div class="section-title">
                            <i class="bi bi-egg-fried text-danger"></i> Nutrition
                        </div>
                        <div class="stat-value">{{ nutrition.percent_tracked|floatformat:0 }}%</div>
                        <div class="stat-label">Days Tracked ({{ nutrition.days_tracked }}/{{ nutrition.days_in_range }})</div>

                        <hr>
                        <div class="mt-3 d-flex">
                            <div class="text-muted small me-3 vertical-label">Daily Averages</div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Calories:</span>
                                    <span>{{ nutrition.avg_calories|floatformat:0|intcomma }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Protein:</span>
                                    <span>{{ nutrition.avg_protein|floatformat:0 }}g</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Carbs:</span>
                                    <span>{{ nutrition.avg_carbs|floatformat:0 }}g</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Fat:</span>
                                    <span>{{ nutrition.avg_fat|floatformat:0 }}g</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Weight Card -->
            {% if weight.count > 0 %}
            <div class="col-md-6 col-lg-4">
                <div class="card report-card">
                    <i class="bi bi-speedometer2 card-icon"></i>
                    <div class="card-body position-relative">
                        <div class="section-title">
                            <i class="bi bi-speedometer2 text-info"></i> Weight
                        </div>
                        <div class="stat-value">{{ weight.end_weight|floatformat:1 }}</div>
                        <div class="stat-label">Current Weight (lbs)</div>

                        <hr>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Weigh-Ins:</span>
                                <span>{{ weight.count }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Change:</span>
                                <span class="{% if weight.change < 0 %}positive-change{% elif weight.change > 0 %}negative-change{% endif %}">
                                    {% if weight.change > 0 %}+{% endif %}{{ weight.change|floatformat:1 }} lbs
                                </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Starting:</span>
                                <span>{{ weight.start_weight|floatformat:1 }} lbs</span>
                            </div>
                            {% if weight.year_change is not None %}
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Change this Year:</span>
                                <span class="{% if weight.year_change < 0 %}positive-change{% elif weight.year_change > 0 %}negative-change{% endif %}">
                                    {% if weight.year_change > 0 %}+{% endif %}{{ weight.year_change|floatformat:1 }} lbs
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        </div>

        <!-- Exercise Section -->
        <div class="row mt-5 mb-3">
            <div class="col-12">
                <h3 class="section-header" data-bs-toggle="collapse" data-bs-target="#exerciseSection" aria-expanded="false" aria-controls="exerciseSection">
                    <i class="bi bi-lightning-charge-fill"></i> Exercise
                    <i class="bi bi-chevron-down chevron"></i>
                </h3>
            </div>
        </div>

        <div id="exerciseSection" class="collapse">
        <div class="row g-4">
            <!-- Workout Cards - One per sport -->
            {% for sport_name, sport_data in workouts_by_sport.items %}
            <div class="col-md-6 col-lg-4">
                <div class="card report-card">
                    <i class="bi bi-lightning-charge card-icon"></i>
                    <div class="card-body position-relative">
                        <div class="section-title">
                            <i class="bi bi-lightning-charge text-success"></i> {{ sport_name }}
                        </div>
                        <div class="stat-value">{{ sport_data.count }}</div>
                        <div class="stat-label">Workouts</div>

                        <hr>
                        <div class="row text-center mt-3">
                            <div class="col-4">
                                <div class="fw-bold">{{ sport_data.total_hours }}h</div>
                                <div class="text-muted small">Total Time Spent</div>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold">{{ sport_data.total_calories|floatformat:0|intcomma }}</div>
                                <div class="text-muted small">Calories Burned</div>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold">{% if sport_data.avg_heart_rate > 0 %}{{ sport_data.avg_heart_rate }}{% else %}-{% endif %}</div>
                                <div class="text-muted small">BPM Avg</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <p class="text-muted">No workout data for this period.</p>
            </div>
            {% endfor %}
        </div>
        </div>

        <!-- Time by Project Section -->
        {% if time_by_project %}
        <div class="row mt-5 mb-3">
            <div class="col-12">
                <h3 class="section-header" data-bs-toggle="collapse" data-bs-target="#timeTrackingSection" aria-expanded="false" aria-controls="timeTrackingSection">
                    <i class="bi bi-clock-history"></i> Time by Project
                    <i class="bi bi-chevron-down chevron"></i>
                </h3>
            </div>
        </div>

        <div id="timeTrackingSection" class="collapse">
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card report-card">
                        <div class="card-body">
                            {% for project_name, project_data in time_by_project.items %}
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-medium">{{ project_name }}</span>
                                    <span class="text-muted">{{ project_data.total_hours|floatformat:1 }}h ({{ project_data.percentage }}%)</span>
                                </div>

                                <!-- Goals breakdown for this project -->
                                {% if project_data.goals %}
                                <div class="goal-breakdown">
                                    {% for goal_name, goal_data in project_data.goals.items %}
                                    <div class="goal-item">
                                        <i class="bi bi-arrow-return-right"></i> {{ goal_name|format_goal_name }}: {{ goal_data.hours|floatformat:1 }}h ({{ goal_data.percentage }}%)
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}

                            <!-- Total Row -->
                            <div class="mt-3 pt-3 total-row-divider">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold">Total</span>
                                    <span class="fw-bold">{{ total_time_hours }}h (100%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Create Objective Modal -->
    <div class="modal fade" id="createObjectiveModal" tabindex="-1" aria-labelledby="createObjectiveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createObjectiveModalLabel">
                        <i class="bi bi-bullseye"></i> <span id="modalTitleText">Create Monthly Objective</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createObjectiveForm">
                    <input type="hidden" id="editObjectiveId" name="objective_id" value="">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="label" class="form-label">Label</label>
                                <input type="text" class="form-control" id="label" name="label" required
                                       placeholder="e.g., 15 Running Workouts">
                            </div>
                            <div class="col-md-6">
                                <label for="objectiveMonth" class="form-label">Month</label>
                                <select class="form-select" id="objectiveMonth" name="month" required>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="objectiveYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="objectiveYear" name="year" required
                                       min="2020" max="2050" placeholder="e.g., 2025">
                            </div>
                            <div class="col-12">
                                <label for="objectiveValue" class="form-label">Target Value</label>
                                <input type="number" class="form-control" id="objectiveValue" name="objective_value"
                                       step="0.01" required placeholder="e.g., 15">
                            </div>
                            <div class="col-12">
                                <label for="objectiveCategory" class="form-label">Category</label>
                                <select class="form-select" id="objectiveCategory" name="category" required>
                                    <option value="">-- Select Category --</option>
                                    {% for category in monthly_objectives.all_categories %}
                                    <option value="{{ category }}">{{ category }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="objectiveDescription" class="form-label">Description</label>
                                <input type="text" class="form-control" id="objectiveDescription" name="description" required
                                       placeholder="e.g., Track running workouts for the month">
                            </div>
                            <div class="col-12">
                                <label for="objectiveUnit" class="form-label">Unit of Measurement</label>
                                <input type="text" class="form-control" id="objectiveUnit" name="unit_of_measurement" required
                                       placeholder="e.g., minutes, sessions, days, pounds">
                            </div>
                            <div class="col-12">
                                <label for="objectiveDefinition" class="form-label">Objective Definition (SQL)</label>
                                <textarea class="form-control" id="objectiveDefinition" name="objective_definition"
                                          rows="4" required placeholder="SELECT COUNT(*) FROM workouts_workout WHERE sport_id = 0 AND DATE(start) >= '2025-12-01' AND DATE(start) <= '2025-12-31'"></textarea>
                                <div id="sqlValidationFeedback" class="form-text"></div>
                            </div>
                            <div class="col-12">
                                <label for="historicalDisplay" class="form-label">
                                    Historical Display Format
                                    <i class="bi bi-info-circle ms-1 form-info-icon" id="historicalDisplayInfo"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="right"
                                       data-bs-html="true"
                                       title="Loading available fields..."></i>
                                </label>
                                <input type="text" class="form-control" id="historicalDisplay" name="historical_display"
                                       placeholder='e.g., {start} - {end}'>
                                <div id="historicalDisplayError" class="invalid-feedback d-block initially-hidden"></div>
                            </div>
                        </div>
                        <div id="createObjectiveError" class="alert alert-danger mt-3 d-none"></div>
                        <div id="createObjectiveSuccess" class="alert alert-success mt-3 d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" id="submitObjectiveBtn" class="btn btn-danger">
                            <i class="bi bi-plus-circle" id="submitBtnIcon"></i> <span id="submitBtnText">Create Objective</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Objective Confirmation Modal -->
    <div class="modal fade" id="deleteObjectiveModal" tabindex="-1" aria-labelledby="deleteObjectiveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteObjectiveModalLabel">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this objective?</p>
                    <p class="fw-bold mb-0" id="deleteObjectiveName"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Objective Detail Modal -->
    <div class="modal fade" id="objectiveDetailModal" tabindex="-1" aria-labelledby="objectiveDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="objectiveDetailModalLabel">
                        <i class="bi bi-info-circle-fill"></i> <span id="objectiveDetailTitle">Objective Details</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="objectiveDetailLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading entries...</p>
                    </div>
                    <div id="objectiveDetailContent" class="d-none">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Description:</strong>
                                <p id="objectiveDetailDescription" class="text-muted"></p>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Target:</strong>
                                        <p id="objectiveDetailTarget"></p>
                                    </div>
                                    <div class="col-6">
                                        <strong>Current:</strong>
                                        <p id="objectiveDetailCurrent"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-list-ul"></i> Recent Entries (<span id="objectiveDetailCount">0</span>)</h6>
                        <div id="objectiveDetailEntries" class="list-group">
                            <!-- Entries will be dynamically inserted here -->
                        </div>
                    </div>
                    <div id="objectiveDetailError" class="alert alert-warning d-none">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span id="objectiveDetailErrorMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Detect and set user timezone in cookie for server-side use
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            document.cookie = `user_timezone=${userTimezone}; path=/; max-age=31536000`; // 1 year

            // Initialize Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                // Check if this tooltip should use HTML content
                const useHtml = tooltipTriggerEl.getAttribute('data-bs-html') === 'true';
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    html: useHtml
                });
            });

            // Handle objective detail icon clicks
            const objectiveDetailIcons = document.querySelectorAll('.objective-detail-icon');
            const objectiveDetailModal = new bootstrap.Modal(document.getElementById('objectiveDetailModal'));

            objectiveDetailIcons.forEach(function(icon) {
                icon.addEventListener('click', function() {
                    const objectiveId = this.getAttribute('data-objective-id');
                    showObjectiveDetail(objectiveId);
                });
            });

            function showObjectiveDetail(objectiveId) {
                // Show the modal
                objectiveDetailModal.show();

                // Reset modal state
                document.getElementById('objectiveDetailLoading').classList.remove('d-none');
                document.getElementById('objectiveDetailContent').classList.add('d-none');
                document.getElementById('objectiveDetailError').classList.add('d-none');

                // Get user's timezone
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                // Fetch the objective entries via AJAX
                fetch(`/targets/api/objective-entries/?objective_id=${objectiveId}&timezone=${encodeURIComponent(userTimezone)}`)
                    .then(response => response.json())
                    .then(data => {
                        // Hide loading spinner
                        document.getElementById('objectiveDetailLoading').classList.add('d-none');

                        if (data.error) {
                            // Show error message
                            document.getElementById('objectiveDetailErrorMessage').textContent = data.error;
                            document.getElementById('objectiveDetailError').classList.remove('d-none');
                        } else if (data.success) {
                            // Populate modal with data
                            document.getElementById('objectiveDetailTitle').textContent = data.objective_label;
                            document.getElementById('objectiveDetailDescription').textContent = data.description || 'No description provided';
                            document.getElementById('objectiveDetailTarget').textContent = `${Math.round(data.target)} ${data.unit}`;
                            document.getElementById('objectiveDetailCurrent').textContent = `${Math.round(data.current)} ${data.unit}`;
                            document.getElementById('objectiveDetailCount').textContent = data.count;

                            // Populate entries list
                            const entriesList = document.getElementById('objectiveDetailEntries');
                            entriesList.innerHTML = '';

                            if (data.entries && data.entries.length > 0) {
                                data.entries.forEach(function(entry) {
                                    const listItem = document.createElement('div');
                                    listItem.className = 'list-group-item';
                                    listItem.textContent = entry;
                                    entriesList.appendChild(listItem);
                                });
                            } else {
                                const noEntries = document.createElement('div');
                                noEntries.className = 'list-group-item text-muted';
                                noEntries.textContent = 'No entries found for this objective.';
                                entriesList.appendChild(noEntries);
                            }

                            // Show content
                            document.getElementById('objectiveDetailContent').classList.remove('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching objective details:', error);
                        document.getElementById('objectiveDetailLoading').classList.add('d-none');
                        document.getElementById('objectiveDetailErrorMessage').textContent = 'Failed to load objective details. Please try again.';
                        document.getElementById('objectiveDetailError').classList.remove('d-none');
                    });
            }

            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            const spinner = document.getElementById('loading-spinner');

            function reloadReport() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                if (startDate && endDate) {
                    // Show loading spinner
                    spinner.classList.remove('d-none');

                    // Reload page with new dates
                    window.location.href = `?start_date=${startDate}&end_date=${endDate}`;
                }
            }

            // Quick Date Picker functionality
            const quickDatePicker = document.getElementById('quick_date_picker');
            let isDropdownTriggered = false;

            // Get current date in user's timezone
            function getUserDate() {
                const now = new Date();
                return now;
            }

            // Format date as YYYY-MM-DD for date input
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Get month name
            function getMonthName(date) {
                return date.toLocaleDateString('en-US', { month: 'short' });
            }

            // Get quarter name
            function getQuarterName(date) {
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                return `Q${quarter}`;
            }

            // Calculate date ranges based on selection
            function getDateRange(selection) {
                const now = getUserDate();
                const year = now.getFullYear();
                const month = now.getMonth();
                const day = now.getDate();

                let startDate, endDate;

                switch(selection) {
                    case 'today':
                        startDate = new Date(year, month, day);
                        endDate = new Date(year, month, day);
                        break;

                    case 'this_month':
                        startDate = new Date(year, month, 1);
                        endDate = new Date(year, month + 1, 0); // Last day of current month
                        break;

                    case 'next_month':
                        startDate = new Date(year, month + 1, 1);
                        endDate = new Date(year, month + 2, 0); // Last day of next month
                        break;

                    case 'next_next_month':
                        startDate = new Date(year, month + 2, 1);
                        endDate = new Date(year, month + 3, 0); // Last day of month after next
                        break;

                    case 'this_quarter':
                        const quarterStartMonth = Math.floor(month / 3) * 3;
                        startDate = new Date(year, quarterStartMonth, 1);
                        endDate = new Date(year, quarterStartMonth + 3, 0); // Last day of quarter
                        break;

                    case 'this_year':
                        startDate = new Date(year, 0, 1); // Jan 1
                        endDate = new Date(year, 11, 31); // Dec 31
                        break;

                    default:
                        return null;
                }

                return {
                    start: formatDate(startDate),
                    end: formatDate(endDate)
                };
            }

            // Populate dropdown labels dynamically
            function populateDropdownLabels() {
                const now = getUserDate();

                // This month (e.g., "Oct")
                const thisMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);
                document.getElementById('this_month_option').textContent = getMonthName(thisMonthDate);

                // Next month (e.g., "Nov")
                const nextMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                document.getElementById('next_month_option').textContent = getMonthName(nextMonthDate);

                // Next next month (e.g., "Dec")
                const nextNextMonthDate = new Date(now.getFullYear(), now.getMonth() + 2, 1);
                document.getElementById('next_next_month_option').textContent = getMonthName(nextNextMonthDate);

                // This quarter (e.g., "Q4")
                document.getElementById('this_quarter_option').textContent = getQuarterName(now);

                // This year (e.g., "2025")
                document.getElementById('this_year_option').textContent = now.getFullYear().toString();
            }

            // Handle dropdown selection
            quickDatePicker.addEventListener('change', function() {
                const selection = this.value;

                if (!selection) return; // "Jump To Date" selected, do nothing

                const dateRange = getDateRange(selection);

                if (dateRange) {
                    // Set flag to prevent dropdown reset
                    isDropdownTriggered = true;

                    // Update date inputs
                    startDateInput.value = dateRange.start;
                    endDateInput.value = dateRange.end;

                    // Trigger reload
                    reloadReport();
                }
            });

            // Initialize dropdown labels on page load
            populateDropdownLabels();

            // Add event listeners to date pickers
            startDateInput.addEventListener('change', function() {
                // Reset dropdown if this wasn't triggered by dropdown
                if (!isDropdownTriggered) {
                    quickDatePicker.value = '';
                }
                isDropdownTriggered = false;
                reloadReport();
            });

            endDateInput.addEventListener('change', function() {
                // Reset dropdown if this wasn't triggered by dropdown
                if (!isDropdownTriggered) {
                    quickDatePicker.value = '';
                }
                isDropdownTriggered = false;
                reloadReport();
            });

            // Handle Create/Edit Objective form
            const createObjectiveForm = document.getElementById('createObjectiveForm');
            const createObjectiveError = document.getElementById('createObjectiveError');
            const createObjectiveSuccess = document.getElementById('createObjectiveSuccess');
            const createObjectiveModal = document.getElementById('createObjectiveModal');
            const modal = bootstrap.Modal.getInstance(createObjectiveModal) || new bootstrap.Modal(createObjectiveModal);
            const objectiveMonthSelect = document.getElementById('objectiveMonth');
            const objectiveYearInput = document.getElementById('objectiveYear');
            const editObjectiveId = document.getElementById('editObjectiveId');
            const modalTitleText = document.getElementById('modalTitleText');
            const labelInput = document.getElementById('label');
            const objectiveValueInput = document.getElementById('objectiveValue');
            const objectiveCategorySelect = document.getElementById('objectiveCategory');
            const objectiveDescriptionInput = document.getElementById('objectiveDescription');
            const objectiveUnitInput = document.getElementById('objectiveUnit');
            const objectiveDefinitionInput = document.getElementById('objectiveDefinition');
            const historicalDisplayInput = document.getElementById('historicalDisplay');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnIcon = document.getElementById('submitBtnIcon');
            const flashMessageContainer = document.getElementById('flashMessageContainer');
            const sqlValidationFeedback = document.getElementById('sqlValidationFeedback');
            const submitObjectiveBtn = document.getElementById('submitObjectiveBtn');

            // Track whether we're in edit mode
            let isEditMode = false;
            let sqlIsValid = false;

            // SQL Validation function
            function validateSQL(sql) {
                const trimmedSQL = sql.trim();

                // Empty check
                if (!trimmedSQL) {
                    return { valid: false, message: '' };
                }

                // Must start with SELECT (case insensitive)
                if (!trimmedSQL.match(/^\s*SELECT/i)) {
                    return {
                        valid: false,
                        message: 'SQL must start with SELECT statement'
                    };
                }

                // Must contain FROM clause
                if (!trimmedSQL.match(/\bFROM\b/i)) {
                    return {
                        valid: false,
                        message: 'SQL must contain a FROM clause'
                    };
                }

                // Check for balanced parentheses
                const openParens = (trimmedSQL.match(/\(/g) || []).length;
                const closeParens = (trimmedSQL.match(/\)/g) || []).length;
                if (openParens !== closeParens) {
                    return {
                        valid: false,
                        message: 'Unbalanced parentheses in SQL query'
                    };
                }

                // Check for balanced single quotes (basic check)
                const singleQuotes = (trimmedSQL.match(/'/g) || []).length;
                if (singleQuotes % 2 !== 0) {
                    return {
                        valid: false,
                        message: 'Unbalanced single quotes in SQL query'
                    };
                }

                // Warn about dangerous operations (but allow them)
                const dangerousKeywords = /\b(DROP|DELETE|UPDATE|INSERT|ALTER|CREATE|TRUNCATE|REPLACE)\b/i;
                if (dangerousKeywords.test(trimmedSQL)) {
                    return {
                        valid: false,
                        message: 'Dangerous SQL operations (DROP, DELETE, UPDATE, etc.) are not allowed. Use SELECT queries only.'
                    };
                }

                // All checks passed
                return {
                    valid: true,
                    message: 'SQL syntax looks valid'
                };
            }

            // Real-time SQL validation
            objectiveDefinitionInput.addEventListener('input', function() {
                const validation = validateSQL(this.value);
                sqlIsValid = validation.valid;

                if (!this.value.trim()) {
                    sqlValidationFeedback.textContent = '';
                    sqlValidationFeedback.className = 'form-text';
                    submitObjectiveBtn.disabled = false;
                } else if (validation.valid) {
                    sqlValidationFeedback.textContent = '✓ ' + validation.message;
                    sqlValidationFeedback.className = 'form-text text-success';
                    submitObjectiveBtn.disabled = false;
                } else {
                    sqlValidationFeedback.textContent = '✗ ' + validation.message;
                    sqlValidationFeedback.className = 'form-text text-danger';
                    submitObjectiveBtn.disabled = true;
                }

                // Update available fields for historical_display when SQL changes
                updateAvailableFields(this.value);
            });

            // Track available fields and validation state
            let availableFields = [];
            let historicalDisplayIsValid = true;

            // Update available fields tooltip based on SQL definition
            function updateAvailableFields(sqlDefinition) {
                if (!sqlDefinition.trim()) {
                    availableFields = [];
                    const tooltip = bootstrap.Tooltip.getInstance(document.getElementById('historicalDisplayInfo'));
                    if (tooltip) {
                        tooltip.setContent({ '.tooltip-inner': 'Enter SQL definition first to see available fields' });
                    }
                    return;
                }

                // Fetch available fields from backend
                fetch(`/targets/api/objective-available-fields/?sql_definition=${encodeURIComponent(sqlDefinition)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.fields) {
                            availableFields = data.fields;
                            const fieldsText = '<strong>Available Fields:</strong><br>' + data.fields.join(', ');

                            // Update or create tooltip
                            const infoIcon = document.getElementById('historicalDisplayInfo');
                            let tooltip = bootstrap.Tooltip.getInstance(infoIcon);
                            if (tooltip) {
                                tooltip.setContent({ '.tooltip-inner': fieldsText });
                            } else {
                                new bootstrap.Tooltip(infoIcon, {
                                    title: fieldsText,
                                    html: true,
                                    placement: 'right'
                                });
                            }

                            // Re-validate historical_display with new fields
                            validateHistoricalDisplay(historicalDisplayInput.value);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching available fields:', error);
                    });
            }

            // Validate historical_display format string
            function validateHistoricalDisplay(value) {
                const errorDiv = document.getElementById('historicalDisplayError');

                if (!value.trim()) {
                    // Empty is okay - it's optional
                    errorDiv.style.display = 'none';
                    historicalDisplayInput.classList.remove('is-invalid');
                    historicalDisplayIsValid = true;
                    return;
                }

                // Check for malformed brackets (mixed [ and { or } and ])
                const malformedBrackets = /[\[{][^[\]{}]*[\]}]/.test(value) && !/\{[^{}]*\}/.test(value.replace(/\[[^\]]*\]/g, ''));
                const hasMixedBrackets = /\[[^[\]]*\}|\{[^{}]*\]/.test(value);

                if (hasMixedBrackets) {
                    errorDiv.textContent = '✗ Malformed placeholder brackets. Use {field_name}, not [field_name} or {field_name]';
                    errorDiv.style.display = 'block';
                    historicalDisplayInput.classList.add('is-invalid');
                    historicalDisplayIsValid = false;
                    return;
                }

                // Extract placeholders from format string
                const placeholderRegex = /{(\w+)}/g;
                const placeholders = [];
                let match;
                while ((match = placeholderRegex.exec(value)) !== null) {
                    placeholders.push(match[1]);
                }

                if (placeholders.length === 0) {
                    // No placeholders - that's okay
                    errorDiv.style.display = 'none';
                    historicalDisplayInput.classList.remove('is-invalid');
                    historicalDisplayIsValid = true;
                    return;
                }

                // Check if we have available fields to validate against
                if (availableFields.length === 0) {
                    errorDiv.textContent = '⚠ Enter a valid SQL definition first to validate field names';
                    errorDiv.style.display = 'block';
                    historicalDisplayInput.classList.add('is-invalid');
                    historicalDisplayIsValid = false;
                    return;
                }

                // Check for invalid placeholders
                const invalidFields = placeholders.filter(p => !availableFields.includes(p));

                if (invalidFields.length > 0) {
                    errorDiv.textContent = `✗ Invalid field(s): ${invalidFields.join(', ')}. Available fields: ${availableFields.join(', ')}`;
                    errorDiv.style.display = 'block';
                    historicalDisplayInput.classList.add('is-invalid');
                    historicalDisplayIsValid = false;
                } else {
                    errorDiv.textContent = `✓ All fields are valid`;
                    errorDiv.style.display = 'block';
                    errorDiv.className = 'text-success small';
                    historicalDisplayInput.classList.remove('is-invalid');
                    historicalDisplayIsValid = true;
                }
            }

            // Add validation listener for historical_display
            historicalDisplayInput.addEventListener('input', function() {
                validateHistoricalDisplay(this.value);
            });

            // Initialize tooltip
            new bootstrap.Tooltip(document.getElementById('historicalDisplayInfo'), {
                title: 'Enter SQL definition first to see available fields',
                html: true,
                placement: 'right'
            });

            // Helper function to show flash message on main page
            function showFlashMessage(message, isError = false) {
                const alertClass = isError ? 'alert-danger' : 'alert-success';
                const iconClass = isError ? 'bi-x-circle-fill' : 'bi-check-circle-fill';

                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    <i class="bi ${iconClass}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                flashMessageContainer.appendChild(alertDiv);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }, 5000);
            }

            // Helper function to update objective row after editing
            function updateObjectiveRow(objectiveId, objective) {
                console.log('updateObjectiveRow called with:', objectiveId, objective);

                // Find the edit button with this objective ID
                const editBtn = document.querySelector(`.edit-objective-btn[data-objective-id="${objectiveId}"]`);
                if (!editBtn) {
                    console.error('Edit button not found for objective:', objectiveId);
                    return;
                }

                // Get the row
                const row = editBtn.closest('tr');
                if (!row) {
                    console.error('Row not found for objective:', objectiveId);
                    return;
                }

                console.log('Found row, updating cells...');
                const cells = row.querySelectorAll('td');
                console.log('Number of cells:', cells.length);

                // Determine if this is the first row in a category (has 8 cells) or not (has 7 cells)
                // First row has category cell with rowspan
                const hasCategoryCell = cells.length === 8;
                const offset = hasCategoryCell ? 1 : 0;

                // Update label cell
                const labelCell = cells[offset];
                labelCell.innerHTML = '';
                labelCell.appendChild(document.createTextNode(objective.label));

                // Add description icon if present
                if (objective.description) {
                    labelCell.appendChild(document.createTextNode(' '));
                    const icon = document.createElement('i');
                    icon.className = 'bi bi-info-circle ms-1';
                    icon.style.cssText = 'cursor: help; font-size: 0.6rem; opacity: 0.4; color: #6c757d;';
                    icon.setAttribute('data-bs-toggle', 'tooltip');
                    icon.setAttribute('data-bs-placement', 'right');
                    icon.setAttribute('title', objective.description);
                    labelCell.appendChild(icon);

                    // Initialize the new tooltip
                    new bootstrap.Tooltip(icon);
                }

                // Cell offsets (skip empty cell at offset+1)
                const targetCell = cells[offset + 2];
                const resultCell = cells[offset + 3];
                const progressCell = cells[offset + 4];

                // Update target with unit and tooltip
                targetCell.textContent = Math.round(objective.target) + (objective.unit ? ' ' + objective.unit : '');

                // Update tooltip - dispose old one and create new with updated title
                const existingTooltip = bootstrap.Tooltip.getInstance(targetCell);
                if (existingTooltip) {
                    existingTooltip.dispose();
                }
                const newTooltipTitle = `Target/week = ${objective.target_per_week}`;
                targetCell.setAttribute('title', newTooltipTitle);
                new bootstrap.Tooltip(targetCell, {
                    title: newTooltipTitle
                });

                // Update result cell - clear and rebuild to preserve info icon
                resultCell.innerHTML = '';
                resultCell.appendChild(document.createTextNode(Math.round(objective.result)));

                // Add info icon if objective definition is not a CTE query
                if (!objective.objective_definition.trim().toUpperCase().startsWith('WITH')) {
                    resultCell.appendChild(document.createTextNode(' '));
                    const detailIcon = document.createElement('i');
                    detailIcon.className = 'bi bi-info-circle-fill ms-1 objective-detail-icon';
                    detailIcon.style.cssText = 'cursor: pointer; font-size: 0.75rem; opacity: 0.6; color: #0d6efd;';
                    detailIcon.setAttribute('data-objective-id', objectiveId);
                    detailIcon.setAttribute('title', 'View details');
                    resultCell.appendChild(detailIcon);

                    // Attach click handler for the new icon
                    detailIcon.addEventListener('click', function() {
                        showObjectiveDetail(objectiveId);
                    });
                }

                // Update tooltip for last entries
                const existingResultTooltip = bootstrap.Tooltip.getInstance(resultCell);
                if (existingResultTooltip) {
                    existingResultTooltip.dispose();
                }

                // Add/update data-last-entries attribute and class
                if (!resultCell.classList.contains('objective-result-cell')) {
                    resultCell.classList.add('objective-result-cell');
                }

                if (objective.last_entries && objective.last_entries.length > 0) {
                    const entriesData = objective.last_entries.join('|||');
                    resultCell.setAttribute('data-last-entries', entriesData);

                    // Build tooltip content
                    const entries = objective.last_entries;
                    const entriesList = entries.map(entry => `<li>${entry}</li>`).join('');
                    const tooltipContent = `<div style="text-align: left;"><strong>Last 5 Entries:</strong><ul class="mb-0 ps-3">${entriesList}</ul></div>`;

                    resultCell.style.cursor = 'help';
                    new bootstrap.Tooltip(resultCell, {
                        html: true,
                        placement: 'right',
                        title: tooltipContent
                    });
                } else {
                    resultCell.removeAttribute('data-last-entries');
                    resultCell.style.cursor = '';
                }

                // Update progress bar
                const progressContainer = progressCell.querySelector('div');
                if (progressContainer) {
                    const progressMarker = progressContainer.querySelector('div[style*="position: absolute"]');
                    const progressText = progressContainer.querySelector('span');

                    const progressWidth = objective.progress_pct > 100 ? 100 : objective.progress_pct;
                    if (progressMarker) {
                        progressMarker.style.left = progressWidth + '%';
                        progressMarker.style.background = objective.achieved ? '#198754' : '#6c757d';
                    }
                    progressContainer.style.background = objective.achieved ? '#d4edda' : '#e9ecef';
                    if (progressText) {
                        progressText.textContent = objective.progress_pct + '%';
                    }
                }

                // Update edit button data attributes
                editBtn.dataset.label = objective.label;
                editBtn.dataset.month = objective.month;
                editBtn.dataset.year = objective.year;
                editBtn.dataset.target = objective.objective_value;
                editBtn.dataset.definition = objective.objective_definition;
                editBtn.dataset.category = objective.category || '';
                editBtn.dataset.description = objective.description || '';
                editBtn.dataset.unit = objective.unit || '';
                editBtn.dataset.historicalDisplay = objective.historical_display || '';

                console.log('Row update complete');
            }

            // Helper function to insert a new objective row dynamically
            function insertNewObjectiveRow(objective) {
                console.log('insertNewObjectiveRow called with:', objective);

                const tbody = document.querySelector('.table-responsive table tbody');
                if (!tbody) {
                    console.error('Table tbody not found');
                    return;
                }

                const category = objective.category || '';
                const isUncategorized = !category;

                // Create the new row HTML
                const newRow = document.createElement('tr');
                newRow.style.height = '45px';

                // Check if category already exists in the table
                let categoryCell = null;
                let categoryRows = [];

                if (!isUncategorized) {
                    // Find all rows in this category by looking for the category cell
                    const allRows = tbody.querySelectorAll('tr');
                    for (let row of allRows) {
                        const firstCell = row.querySelector('td:first-child');
                        if (firstCell && firstCell.textContent.trim() === category) {
                            categoryCell = firstCell;
                            // Find all rows in this category group
                            let currentRow = row;
                            categoryRows.push(currentRow);
                            while (currentRow = currentRow.nextElementSibling) {
                                const nextFirstCell = currentRow.querySelector('td:first-child');
                                // If next row doesn't have a category cell or has different category, stop
                                if (!nextFirstCell || nextFirstCell.hasAttribute('rowspan') || nextFirstCell.textContent.trim() === '—') {
                                    break;
                                }
                                categoryRows.push(currentRow);
                            }
                            break;
                        }
                    }
                }

                // Build row cells
                let rowHTML = '';

                // If category doesn't exist yet, this is the first row in the category
                if (!isUncategorized && !categoryCell) {
                    rowHTML += `<td class="align-middle" rowspan="1">${category}</td>`;
                }

                // Label cell with description tooltip if present
                rowHTML += `<td class="align-middle" style="white-space: nowrap;">
                    ${objective.label}`;
                if (objective.description) {
                    rowHTML += ` <i class="bi bi-info-circle ms-1"
                       style="cursor: help; font-size: 0.6rem; opacity: 0.4; color: #6c757d;"
                       data-bs-toggle="tooltip"
                       data-bs-placement="right"
                       title="${objective.description}"></i>`;
                }
                rowHTML += `</td>`;

                // Empty cell
                rowHTML += `<td></td>`;

                // Target cell with tooltip
                const targetPerWeek = objective.target_per_week || 0;
                rowHTML += `<td class="text-center align-middle" style="padding-right: 30px; cursor: help;"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Target/week = ${targetPerWeek.toFixed(1)}">${Math.round(objective.target)}${objective.unit ? ' ' + objective.unit : ''}</td>`;

                // Current/Result cell with data for tooltip
                let currentCellHTML = '<td class="text-center align-middle objective-result-cell" style="padding-right: 30px;"';
                if (objective.last_entries && objective.last_entries.length > 0) {
                    const entriesData = objective.last_entries.join('|||');
                    currentCellHTML += ` data-last-entries="${entriesData}"`;
                }
                currentCellHTML += `>${Math.round(objective.result)}</td>`;
                rowHTML += currentCellHTML;

                // Progress bar cell
                const progressWidth = objective.progress_pct > 100 ? 100 : objective.progress_pct;
                const bgColor = objective.achieved ? '#d4edda' : '#e9ecef';
                const markerColor = objective.achieved ? '#198754' : '#6c757d';
                rowHTML += `<td class="align-middle">
                    <div style="position: relative; height: 20px; background: ${bgColor}; border-radius: 3px;">
                        <div style="position: absolute; left: ${progressWidth}%; top: 0; width: 2px; height: 20px; background: ${markerColor};"></div>
                        <span style="position: absolute; left: 5px; top: 2px; font-size: 0.75rem;">${objective.progress_pct}%</span>
                    </div>
                </td>`;

                // Actions cell
                rowHTML += `<td class="text-end">
                    <a href="#" class="text-primary edit-objective-btn me-2"
                       data-objective-id="${objective.objective_id}"
                       data-label="${objective.label}"
                       data-month="${objective.month}"
                       data-year="${objective.year}"
                       data-target="${objective.objective_value}"
                       data-definition="${objective.objective_definition}"
                       data-category="${objective.category || ''}"
                       data-description="${objective.description || ''}"
                       data-unit="${objective.unit || ''}"
                       data-historical-display="${objective.historical_display || ''}"
                       title="Edit objective">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="#" class="text-danger delete-objective-btn"
                       data-objective-id="${objective.objective_id}"
                       data-label="${objective.label}"
                       title="Delete objective">
                        <i class="bi bi-trash"></i>
                    </a>
                </td>`;

                // For uncategorized objectives
                if (isUncategorized) {
                    // Add the "—" category marker for uncategorized
                    rowHTML = `<td class="text-secondary align-middle">—</td>` + rowHTML;
                }

                newRow.innerHTML = rowHTML;

                // Insert the row in the appropriate position
                if (!isUncategorized && categoryCell) {
                    // Category exists - update rowspan and insert after last row in category
                    const currentRowspan = parseInt(categoryCell.getAttribute('rowspan') || '1');
                    categoryCell.setAttribute('rowspan', currentRowspan + 1);
                    const lastRowInCategory = categoryRows[categoryRows.length - 1];
                    lastRowInCategory.after(newRow);
                } else if (!isUncategorized && !categoryCell) {
                    // New category - insert before uncategorized section
                    // Find first uncategorized row (has "—" in first cell)
                    const allRows = tbody.querySelectorAll('tr');
                    let insertBeforeRow = null;
                    for (let row of allRows) {
                        const firstCell = row.querySelector('td:first-child');
                        if (firstCell && firstCell.textContent.trim() === '—') {
                            insertBeforeRow = row;
                            break;
                        }
                    }
                    if (insertBeforeRow) {
                        insertBeforeRow.before(newRow);
                    } else {
                        tbody.appendChild(newRow);
                    }
                } else {
                    // Uncategorized - append to end of table
                    tbody.appendChild(newRow);
                }

                // Initialize tooltips on the new row
                const tooltips = newRow.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltips.forEach(el => {
                    const useHtml = el.getAttribute('data-bs-html') === 'true';
                    new bootstrap.Tooltip(el, { html: useHtml });
                });

                // Initialize tooltip for result cell if it has last entries
                const resultCell = newRow.querySelector('.objective-result-cell[data-last-entries]');
                if (resultCell) {
                    const entriesData = resultCell.getAttribute('data-last-entries');
                    if (entriesData) {
                        const entries = entriesData.split('|||');
                        const entriesList = entries.map(entry => `<li>${entry}</li>`).join('');
                        const tooltipContent = `<div style="text-align: left;"><strong>Last 5 Entries:</strong><ul class="mb-0 ps-3">${entriesList}</ul></div>`;

                        resultCell.style.cursor = 'help';
                        new bootstrap.Tooltip(resultCell, {
                            html: true,
                            placement: 'right',
                            title: tooltipContent
                        });
                    }
                }

                console.log('New row inserted successfully');
            }

            // Handle edit button clicks using event delegation
            document.body.addEventListener('click', function(e) {
                const editBtn = e.target.closest('.edit-objective-btn');
                if (editBtn) {
                    e.preventDefault();

                    // Set edit mode flag BEFORE opening modal
                    isEditMode = true;

                    // Debug: Log all dataset values
                    console.log('Edit button clicked. Dataset:', {
                        objectiveId: editBtn.dataset.objectiveId,
                        label: editBtn.dataset.label,
                        month: editBtn.dataset.month,
                        year: editBtn.dataset.year,
                        target: editBtn.dataset.target,
                        definition: editBtn.dataset.definition
                    });

                    // Populate form with objective data
                    editObjectiveId.value = editBtn.dataset.objectiveId || '';
                    labelInput.value = editBtn.dataset.label || '';
                    objectiveMonthSelect.value = editBtn.dataset.month || '';
                    objectiveYearInput.value = editBtn.dataset.year || '';
                    objectiveValueInput.value = editBtn.dataset.target || '';
                    objectiveCategorySelect.value = editBtn.dataset.category || '';
                    objectiveDescriptionInput.value = editBtn.dataset.description || '';
                    objectiveUnitInput.value = editBtn.dataset.unit || '';
                    objectiveDefinitionInput.value = editBtn.dataset.definition || '';
                    historicalDisplayInput.value = editBtn.dataset.historicalDisplay || '';

                    // Update available fields for historical_display when editing
                    if (editBtn.dataset.definition) {
                        updateAvailableFields(editBtn.dataset.definition);
                    }

                    // Debug: Log form values after setting
                    console.log('Form values set:', {
                        editObjectiveId: editObjectiveId.value,
                        label: labelInput.value,
                        month: objectiveMonthSelect.value,
                        year: objectiveYearInput.value,
                        target: objectiveValueInput.value,
                        definition: objectiveDefinitionInput.value
                    });

                    // Update modal title and button text for edit mode
                    modalTitleText.textContent = 'Edit Monthly Objective';
                    submitBtnText.textContent = 'Save Changes';
                    submitBtnIcon.className = 'bi bi-save';

                    // Open modal
                    const modalInstance = bootstrap.Modal.getInstance(createObjectiveModal) || new bootstrap.Modal(createObjectiveModal);
                    modalInstance.show();
                }
            });

            // Handle delete button clicks using event delegation
            let deleteObjectiveId = null;
            const deleteObjectiveModal = document.getElementById('deleteObjectiveModal');
            const deleteObjectiveName = document.getElementById('deleteObjectiveName');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            document.body.addEventListener('click', function(e) {
                const deleteBtn = e.target.closest('.delete-objective-btn');
                if (deleteBtn) {
                    e.preventDefault();

                    // Store the objective ID and label for deletion
                    deleteObjectiveId = deleteBtn.dataset.objectiveId;
                    deleteObjectiveName.textContent = deleteBtn.dataset.label;

                    // Show the confirmation modal
                    const modalInstance = new bootstrap.Modal(deleteObjectiveModal);
                    modalInstance.show();
                }
            });

            // Handle confirm delete button click
            confirmDeleteBtn.addEventListener('click', function() {
                if (!deleteObjectiveId) return;

                // Call the delete API
                fetch('/targets/api/delete-objective/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        objective_id: deleteObjectiveId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close the modal
                        const modalInstance = bootstrap.Modal.getInstance(deleteObjectiveModal);
                        modalInstance.hide();

                        // Reload the page to reflect changes
                        window.location.reload();
                    } else {
                        alert('Error deleting objective: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting objective. Please try again.');
                });
            });

            // Pre-populate month/year from current end_date when modal opens for CREATE
            createObjectiveModal.addEventListener('show.bs.modal', function(e) {
                // Check if we're NOT in edit mode
                if (!isEditMode) {
                    // Reset form for create mode
                    createObjectiveForm.reset();
                    editObjectiveId.value = '';
                    modalTitleText.textContent = 'Create Monthly Objective';
                    submitBtnText.textContent = 'Create Objective';
                    submitBtnIcon.className = 'bi bi-plus-circle';

                    // Pre-populate month/year from current end_date
                    const currentEndDate = endDateInput.value;
                    if (currentEndDate) {
                        const endDate = new Date(currentEndDate);
                        objectiveMonthSelect.value = endDate.getMonth() + 1; // getMonth() is 0-indexed
                        objectiveYearInput.value = endDate.getFullYear();
                    }

                    // Reset SQL validation
                    sqlValidationFeedback.textContent = '';
                    sqlValidationFeedback.className = 'form-text';
                    submitObjectiveBtn.disabled = false;
                } else {
                    // In edit mode, validate the existing SQL
                    const validation = validateSQL(objectiveDefinitionInput.value);
                    sqlIsValid = validation.valid;

                    if (validation.valid) {
                        sqlValidationFeedback.textContent = '✓ ' + validation.message;
                        sqlValidationFeedback.className = 'form-text text-success';
                        submitObjectiveBtn.disabled = false;
                    } else {
                        sqlValidationFeedback.textContent = '✗ ' + validation.message;
                        sqlValidationFeedback.className = 'form-text text-danger';
                        submitObjectiveBtn.disabled = true;
                    }
                }
                // Reset the flag after modal is shown
                isEditMode = false;
            });

            createObjectiveForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Hide previous messages
                createObjectiveError.classList.add('d-none');
                createObjectiveSuccess.classList.add('d-none');

                // Get form data
                const formData = new FormData(createObjectiveForm);
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                // Determine if we're creating or updating
                const isEdit = editObjectiveId.value !== '';
                const url = isEdit ? '/targets/api/update-objective/' : '/targets/api/create-objective/';

                // Validate required fields
                const requiredFields = {
                    'label': 'Label',
                    'month': 'Month',
                    'year': 'Year',
                    'objective_value': 'Target Value',
                    'objective_definition': 'SQL Definition',
                    'category': 'Category',
                    'description': 'Description',
                    'unit_of_measurement': 'Unit of Measurement'
                };

                const missingFields = [];
                for (const [field, label] of Object.entries(requiredFields)) {
                    if (!data[field] || data[field].trim() === '') {
                        missingFields.push(label);
                    }
                }

                if (missingFields.length > 0) {
                    createObjectiveError.textContent = 'Please fill in all required fields: ' + missingFields.join(', ');
                    createObjectiveError.classList.remove('d-none');
                    return; // Stop submission
                }

                // Validate historical_display format if provided
                if (data.historical_display && data.historical_display.trim()) {
                    if (!historicalDisplayIsValid) {
                        createObjectiveError.textContent = 'Please fix the errors in Historical Display Format before saving.';
                        createObjectiveError.classList.remove('d-none');
                        return; // Stop submission
                    }
                }

                // DEBUG: Log what we're sending
                console.log('=== OBJECTIVE FORM SUBMISSION ===');
                console.log('Mode:', isEdit ? 'UPDATE' : 'CREATE');
                console.log('URL:', url);
                console.log('Form Data:', data);
                console.log('historical_display value:', data.historical_display);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    // DEBUG: Log what we received
                    console.log('Response status:', response.status);
                    console.log('Response data:', result);
                    if (result.objective) {
                        console.log('Returned objective.historical_display:', result.objective.historical_display);
                    }

                    if (response.ok) {
                        // Close the modal immediately
                        const modalInstance = bootstrap.Modal.getInstance(createObjectiveModal) || new bootstrap.Modal(createObjectiveModal);
                        modalInstance.hide();

                        // Show flash message on main page
                        showFlashMessage(result.message || 'Objective saved successfully!');

                        // If editing, update the table row with new data
                        if (isEdit && result.objective) {
                            updateObjectiveRow(result.objective_id, result.objective);
                        } else if (result.in_current_range && result.objective) {
                            // If creating a new objective in current range, insert it dynamically
                            insertNewObjectiveRow(result.objective);
                        }

                        // Reset form
                        createObjectiveForm.reset();
                        editObjectiveId.value = '';
                    } else {
                        createObjectiveError.textContent = result.error || 'Failed to save objective';
                        createObjectiveError.classList.remove('d-none');
                    }
                } catch (error) {
                    createObjectiveError.textContent = 'Network error: ' + error.message;
                    createObjectiveError.classList.remove('d-none');
                }
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Master Sync functionality
            window.runMasterSync = function() {
            // Get CSRF token
            const csrftoken = getCookie('csrftoken');

            // Get the sync button
            const syncButton = document.querySelector('button[onclick="runMasterSync()"]');
            const originalText = syncButton.innerHTML;

            // Disable button and show loading state
            syncButton.disabled = true;
            syncButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';

            // Make AJAX request
            fetch('{% url "fasting:master_sync" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSyncOutputModal(data.results, data.has_errors, data.auth_errors);
                } else {
                    showFlashMessage(data.message || 'Error running sync', true);
                    if (data.traceback) {
                        console.error('Sync error traceback:', data.traceback);
                    }
                }
            })
            .catch(error => {
                showFlashMessage('Network error: Could not run sync', true);
                console.error('Error:', error);
            })
            .finally(() => {
                syncButton.disabled = false;
                syncButton.innerHTML = originalText;
            });
            }

            window.showSyncOutputModal = function(results, hasErrors, authErrors = {}) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('syncOutputModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'syncOutputModal';
                modal.className = 'modal fade';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Sync Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div id="authErrorsSection"></div>
                                <div id="syncResultsContent"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Build results display from structured data
            const resultsContent = document.getElementById('syncResultsContent');
            if (results && Object.keys(results).length > 0) {
                let html = '<table class="table table-sm mb-0">';
                html += '<thead><tr><th>Source</th><th>Status</th><th>Created</th><th>Updated</th><th>Skipped</th></tr></thead><tbody>';
                for (const [source, r] of Object.entries(results)) {
                    const icon = r.success ? '✓' : '✗';
                    const rowClass = r.success ? '' : 'table-danger';
                    html += `<tr class="${rowClass}">`;
                    html += `<td><strong>${icon} ${source.charAt(0).toUpperCase() + source.slice(1)}</strong></td>`;
                    if (r.success) {
                        html += `<td class="text-success">OK</td>`;
                        html += `<td>${r.created}</td><td>${r.updated}</td><td>${r.skipped}</td>`;
                    } else {
                        html += `<td class="text-danger" colspan="4">${r.error || r.summary || 'Failed'}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';
                resultsContent.innerHTML = html;
            } else {
                resultsContent.innerHTML = '<p class="text-muted">No sync results available.</p>';
            }

            // Show authentication error section if there are auth errors
            const authErrorsSection = document.getElementById('authErrorsSection');
            if (authErrors && Object.keys(authErrors).length > 0) {
                let authHtml = '<div class="alert alert-warning mb-3"><strong>🔐 Authentication Required</strong><br>';
                authHtml += 'Some services need re-authentication. Click below to authorize:<br><br>';

                if (authErrors.whoop) {
                    authHtml += '<a href="/oauth/whoop/authorize/" class="btn btn-sm btn-primary me-2">Re-authenticate Whoop</a>';
                }
                if (authErrors.withings) {
                    authHtml += '<a href="/oauth/withings/authorize/" class="btn btn-sm btn-primary me-2">Re-authenticate Withings</a>';
                }
                if (authErrors.cronometer) {
                    authHtml += '<span class="btn btn-sm btn-outline-secondary me-2 disabled">Cronometer: check credentials</span>';
                }

                authHtml += '</div>';
                authErrorsSection.innerHTML = authHtml;
            } else {
                authErrorsSection.innerHTML = '';
            }

            // Change modal header color based on errors
            const modalHeader = modal.querySelector('.modal-header');
            if (hasErrors) {
                modalHeader.style.backgroundColor = '#fff3cd';
                modalHeader.querySelector('.modal-title').textContent = '⚠️ Sync Details (Some Errors)';
            } else {
                modalHeader.style.backgroundColor = '#d1e7dd';
                modalHeader.querySelector('.modal-title').textContent = '✓ Sync Details (Success)';
            }

            // Show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            }
        });

    </script>
</body>
</html>
{% endtimezone %}
